# Nginx Configuration Fix - Quick Start Guide

## What Was Fixed

This PR addresses all the issues mentioned in the problem statement:

1. ✅ **Duplicate server_name entries** - Removed via `remove_duplicate_configs()` function
2. ✅ **Backticks in headers** - Stripped using `perl -0777 -pe 's/\x60//g'`
3. ✅ **Wrong redirect patterns** - Changed from `$server_name` to `$host`
4. ✅ **Duplicate CSP headers** - Removed from vhosts, centralized in `zz-security-headers.conf`
5. ✅ **Duplicate gateway configs** - Removed `pf_gateway_*.conf` files

## Files Changed

### Scripts Enhanced
- ✅ `scripts/pf-fix-nginx-headers-redirect.sh` - Now handles all issues comprehensively
- ✅ `scripts/vps-nginx-fix-one-liner.sh` - NEW: Standalone VPS deployment script

### Deployment Configs Fixed (9 files)
All nginx configs now use `return 301 https://$host$request_uri;`

### Documentation Added
- ✅ `NGINX_FIX_README.md` - Comprehensive guide (227 lines)
- ✅ `test-nginx-fix.sh` - Validation test suite (9 tests)

## How to Use

### Option 1: Run Enhanced Script (Recommended for Development)
```bash
sudo bash scripts/pf-fix-nginx-headers-redirect.sh
```

### Option 2: VPS One-Liner (Recommended for Production VPS)

**Step 1:** Display the one-liner command:
```bash
bash scripts/vps-nginx-fix-one-liner.sh
```

**Step 2:** Copy the displayed command and run it on your VPS server.

**OR** Execute directly:
```bash
sudo bash scripts/vps-nginx-fix-one-liner.sh --execute
```

### Option 3: Custom Domain
```bash
sudo DOMAIN=yourdomain.com bash scripts/pf-fix-nginx-headers-redirect.sh
```

## What the Script Does

1. **Creates centralized security headers** (`/etc/nginx/conf.d/zz-security-headers.conf`):
   - Strict-Transport-Security
   - Content-Security-Policy (without backticks)
   - X-Content-Type-Options
   - X-Frame-Options
   - Referrer-Policy

2. **Fixes all vhosts** in `/etc/nginx` and `/var/www/vhosts/system`:
   - Changes `return 301 https://$server_name$request_uri;` to `https://$host$request_uri;`
   - Removes duplicate CSP headers
   - Strips all backticks

3. **Removes duplicate configs**:
   - `zz-redirect.conf` (when Plesk vhost exists)
   - `pf_gateway_${DOMAIN}.conf`
   - `pf_gateway_www.${DOMAIN}.conf`

4. **Validates and reloads** Nginx

5. **Verifies** headers and redirects (shows if backticks are present)

## Verification After Running

### Check HTTPS Headers (should have NO backticks)
```bash
curl -I https://nexuscos.online/ | grep -E "Strict-Transport-Security|Content-Security-Policy|X-Content-Type-Options|X-Frame-Options|Referrer-Policy"
```

**Expected:**
```
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Content-Security-Policy: default-src 'self' https://nexuscos.online; img-src 'self' data: blob: https://nexuscos.online; script-src 'self' 'unsafe-inline' https://nexuscos.online; style-src 'self' 'unsafe-inline' https://nexuscos.online; connect-src 'self' https://nexuscos.online https://nexuscos.online/streaming wss://nexuscos.online ws://nexuscos.online;
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Referrer-Policy: no-referrer-when-downgrade
```

### Check HTTP Redirect (should have NO backticks)
```bash
curl -I http://nexuscos.online/
```

**Expected:**
```
HTTP/1.1 301 Moved Permanently
Location: https://nexuscos.online/
```

### Check for Nginx Warnings
```bash
sudo nginx -t
```

**Expected:** No duplicate server_name warnings

## VPS One-Liner Command

Here's the complete one-liner you can copy and run on your VPS:

```bash
sudo bash -c 'set -e
DOMAIN=nexuscos.online

# Write clean security headers (single source of truth)
cat >/etc/nginx/conf.d/zz-security-headers.conf <<'\''EOF'\''
# Nexus COS Security Headers
# Generated by VPS Nginx Fix One-Liner

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy
add_header Content-Security-Policy "default-src '\''self'\'' https://nexuscos.online; img-src '\''self'\'' data: blob: https://nexuscos.online; script-src '\''self'\'' '\''unsafe-inline'\'' https://nexuscos.online; style-src '\''self'\'' '\''unsafe-inline'\'' https://nexuscos.online; connect-src '\''self'\'' https://nexuscos.online https://nexuscos.online/streaming wss://nexuscos.online ws://nexuscos.online;" always;

# X-Content-Type-Options
add_header X-Content-Type-Options "nosniff" always;

# X-Frame-Options
add_header X-Frame-Options "SAMEORIGIN" always;

# Referrer-Policy
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# X-XSS-Protection (Legacy)
add_header X-XSS-Protection "1; mode=block" always;
EOF

# Ensure nginx.conf includes conf.d/*.conf
grep -q "conf.d/.*\.conf" /etc/nginx/nginx.conf || sed -i "/^http[[:space:]]*{/a \    include /etc/nginx/conf.d/*.conf;" /etc/nginx/nginx.conf

# Fix redirect in all vhosts and strip backticks + duplicate CSP lines
for ROOT in /etc/nginx /var/www/vhosts/system; do
  [ -d "$ROOT" ] || continue
  
  # Normalize redirect patterns for apex+www
  for VF in $(grep -RIl --include="*.conf" -E "server_name.*($DOMAIN|www\.$DOMAIN)" "$ROOT" 2>/dev/null || true); do
    # Fix redirect patterns
    sed -i "s|return[[:space:]]*301[[:space:]]*https://\$server_name\$request_uri;|return 301 https://\$host\$request_uri;|g" "$VF"
    sed -i "s|return[[:space:]]*301[[:space:]]*https://[a-zA-Z0-9.-]*\$request_uri;|return 301 https://\$host\$request_uri;|g" "$VF"
    sed -i "s|return[[:space:]]*301[[:space:]]*https://;|return 301 https://\$host\$request_uri;|g" "$VF"
    
    # Remove any CSP add_header from vhosts so only zz-security-headers.conf applies
    sed -i "/add_header[[:space:]]\+Content-Security-Policy/d" "$VF"
  done
  
  # Strip any stray backticks from all confs
  if command -v perl &> /dev/null; then
    find "$ROOT" -type f -name "*.conf" -print0 2>/dev/null | xargs -0 perl -0777 -pe "s/\x60//g" -i 2>/dev/null || true
  else
    find "$ROOT" -type f -name "*.conf" -exec sed -i "s/\`//g" {} \; 2>/dev/null || true
  fi
done

# If Plesk vhost exists, remove our redirect file to avoid duplicate server_name warnings
if ls /var/www/vhosts/system/"$DOMAIN"/conf/vhost_nginx.conf >/dev/null 2>&1 || \
   ls /var/www/vhosts/system/"$DOMAIN"/conf/nginx.conf >/dev/null 2>&1; then
  rm -f /etc/nginx/conf.d/zz-redirect.conf
fi

# Remove known duplicate gateway confs
rm -f /etc/nginx/conf.d/pf_gateway_${DOMAIN}.conf /etc/nginx/conf.d/pf_gateway_www.${DOMAIN}.conf

# Validate and reload
nginx -t && systemctl reload nginx

# Verify
echo "--- HTTPS HEADERS ---"
curl -fsSI "https://$DOMAIN/" 2>/dev/null | tr -d "\r" | egrep -i "^(Strict-Transport-Security|Content-Security-Policy|X-Content-Type-Options|X-Frame-Options|Referrer-Policy):" || echo "Could not fetch HTTPS headers (this is normal if testing locally)"

echo ""
echo "--- HTTP REDIRECT ---"
curl -fsSI "http://$DOMAIN/" 2>/dev/null | tr -d "\r" | egrep -i "^(HTTP|Location):" || echo "Could not fetch HTTP redirect (this is normal if testing locally)"

echo ""
echo "--- VERIFICATION COMPLETE ---"
echo "✓ Security headers configured in /etc/nginx/conf.d/zz-security-headers.conf"
echo "✓ Redirect patterns normalized to https://\$host\$request_uri"
echo "✓ Duplicate CSP headers removed from vhosts"
echo "✓ Backticks stripped from all configs"
echo "✓ Duplicate configs removed"
echo "✓ Nginx validated and reloaded"
'
```

## Test Results

All validations pass:
- ✅ Bash syntax valid for both scripts
- ✅ All 9 redirects use `$host` variable
- ✅ No backticks in deployment configs
- ✅ All security headers present
- ✅ All fix functions implemented
- ✅ CodeQL security scan passed

## Support

For detailed information, see:
- `NGINX_FIX_README.md` - Full documentation with troubleshooting
- `scripts/pf-fix-nginx-headers-redirect.sh` - Enhanced script with comments
- `scripts/vps-nginx-fix-one-liner.sh` - VPS deployment script

---

**Ready to deploy!** Choose your preferred method above and run it on your VPS server.
