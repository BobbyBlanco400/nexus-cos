name: TRAE VPS Deploy (Verification + Deploy)

on:
  pull_request:
  workflow_dispatch:

jobs:
  verify-and-deploy-instructions:
    name: Verify Phase 5 Canon and Provide Deploy Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci || npm install

      - name: Run Canon Verification (local verifier)
        run: |
          echo "üîç Verifying N3XUS v-COS Canon (Phase 5 enforcement)..."
          node scripts/verify-phases.js

      - name: Prepare Deploy Package
        run: |
          echo "üì¶ Preparing deploy package for TRAE Solo Coder..."
          mkdir -p deploy
          tar -czf deploy/phase5-deploy-package.tar.gz PHASE5_CANON.md README.md scripts bootstrap.sh || true
          ls -la deploy

      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: phase5-deploy-package
          path: deploy/phase5-deploy-package.tar.gz

  optional-vps-deploy:
    name: Optional: Deploy to Sovereign VPS (manual, requires secrets)
    runs-on: ubuntu-latest
    needs: verify-and-deploy-instructions
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH Client
        run: sudo apt-get update && sudo apt-get install -y openssh-client rsync

      - name: Retrieve deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: phase5-deploy-package
          path: deploy

      - name: Unpack artifact
        run: tar -xzf deploy/phase5-deploy-package.tar.gz -C deploy

      - name: Configure SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts || true

      - name: Deploy to VPS via rsync + remote script
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH || '/opt/n3xus/phase5' }}
        run: |
          echo "‚§µÔ∏è Syncing deploy package to $SSH_USER@$SSH_HOST:$REMOTE_PATH"
          rsync -avz -e "ssh -p $SSH_PORT -i ~/.ssh/id_rsa" deploy/phase5-deploy-package.tar.gz \
            "$SSH_USER@$SSH_HOST:$REMOTE_PATH/"
          echo "üîß Running remote install and systemd restart (requires sudo on remote)"
          ssh -p $SSH_PORT -i ~/.ssh/id_rsa $SSH_USER@$SSH_HOST bash -s <<'EOF'
            set -e
            mkdir -p "$REMOTE_PATH"
            tar -xzf "$REMOTE_PATH/phase5-deploy-package.tar.gz" -C "$REMOTE_PATH" || true
            # Example remote install steps (customize per host)
            if [ -f "$REMOTE_PATH/bootstrap.sh" ]; then
              chmod +x "$REMOTE_PATH/bootstrap.sh"
              nohup bash "$REMOTE_PATH/bootstrap.sh" > "$REMOTE_PATH/bootstrap.log" 2>&1 &
            fi
            # Reload systemd service if present (unit must be supplied by TRAE)
            if command -v systemctl >/dev/null 2>&1; then
              sudo systemctl daemon-reload || true
              sudo systemctl restart n3xus-phase5 || true
            fi
            echo "‚úÖ Remote deploy steps executed (check remote logs)."
          EOF