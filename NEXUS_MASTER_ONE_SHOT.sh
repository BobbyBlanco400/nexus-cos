#!/bin/bash
#
# â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
# â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
# â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•    â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
#
# NEXUS MASTER ONE-SHOT: AI-FUSED CONTROL DASHBOARD
# Complete Platform Stack Deployment in Single Command
#
# Version: 2025.1.0-MASTER
# Architecture: Tony Stark-Level Integrated Control System
# Date: 2025-12-24
#
# INTEGRATED SYSTEMS:
# - NEXUS COS Platform (N3XUS STREAM, Casino-Nexus Lounge, 9-Card Grid)
# - 20+ Verified Family & Urban Tenants
# - NexCoin Wallet + 11 Founder Access Keys + Gating
# - Sovern Build Optimizations (Hostinger VPS)
# - NexusVision + HoloCore + StreaCore (VR/AR Streaming)
# - Nexus-Net 5G Hybrid Connectivity
# - Nexus-Handshake 55-45-17 Compliance
# - PWA Offline-First Capabilities
# - Docker Multi-Service Orchestration (32+ microservices)
# - Health Checks, Logging, Alerts, Zero-Downtime Overlay Deployment
# - Interactive Control Panel (Deploy, Verify, Scale, Monitor)
#
# DEPLOYMENT:

# Source the nginx safe deployment library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/lib/nginx-safe-deploy.sh" ]]; then
    source "$SCRIPT_DIR/lib/nginx-safe-deploy.sh"
else
    echo "ERROR: nginx-safe-deploy.sh library not found"
    exit 1
fi
# ssh root@VPS_IP "curl -fsSL https://raw.githubusercontent.com/BobbyBlanco400/nexus-cos/main/NEXUS_MASTER_ONE_SHOT.sh | sudo bash -s"
#
# -----------------------------------------------------------------------------------

set -euo pipefail

# ---------------------------
# GLOBAL CONFIGURATION
# ---------------------------
export NEXUS_VERSION="2025.1.0-MASTER"
export NEXUS_ENVIRONMENT="production"
export NEXUS_DOMAIN="n3xuscos.online"
export NEXUS_SSL_PATH="/etc/letsencrypt/live/${NEXUS_DOMAIN}"
export NEXUS_REPO_PATH="/var/www/nexus-cos"
export NEXUS_LOG_DIR="/var/log/nexus-cos"
export NEXUS_LOCK_DIR="/var/lock"
export NEXUS_CONFIG_DIR="${NEXUS_REPO_PATH}/config"
export N3XUS_HANDSHAKE="55-45-17"
export NEXUS_HANDSHAKE="55-45-17"
export X_N3XUS_HANDSHAKE="55-45-17"

# Logging
LOGFILE="${NEXUS_LOG_DIR}/nexus-master-$(date +%F_%T).log"
mkdir -p "${NEXUS_LOG_DIR}"
exec 3>&1 1>"${LOGFILE}" 2>&1

# Lock Management
LOCKFILE="${NEXUS_LOCK_DIR}/nexus-master.lock"
if [ -e "${LOCKFILE}" ]; then
    echo "âŒ Deployment lock exists. Exiting." >&3
    exit 1
fi
touch "${LOCKFILE}"
trap "rm -f '${LOCKFILE}'" EXIT

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ---------------------------
# LOGGING FUNCTIONS
# ---------------------------
log_success() { echo -e "${GREEN}âœ… $1${NC}" | tee -a /dev/fd/3; }
log_error() { echo -e "${RED}âŒ $1${NC}" | tee -a /dev/fd/3; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}" | tee -a /dev/fd/3; }
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}" | tee -a /dev/fd/3; }
log_step() { echo -e "${CYAN}ðŸ”· $1${NC}" | tee -a /dev/fd/3; }
log_header() { echo -e "${MAGENTA}$1${NC}" | tee -a /dev/fd/3; }

# ---------------------------
# BANNER
# ---------------------------
clear
log_header "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                           â•‘
â•‘        â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                      â•‘
â•‘        â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•                      â•‘
â•‘        â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                      â•‘
â•‘        â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘                      â•‘
â•‘        â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘                      â•‘
â•‘        â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•                      â•‘
â•‘                                                                           â•‘
â•‘              MASTER ONE-SHOT: AI-FUSED CONTROL DASHBOARD                 â•‘
â•‘                                                                           â•‘
â•‘  ðŸš€ Tony Stark-Level Integrated Deployment System                        â•‘
â•‘  ðŸŽ¯ Version: ${NEXUS_VERSION}                                            â•‘
â•‘  ðŸŒ Domain: ${NEXUS_DOMAIN}                                              â•‘
â•‘  ðŸ“… $(date '+%Y-%m-%d %H:%M:%S %Z')                                      â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"
log_info "Initializing NEXUS MASTER ONE-SHOT deployment..."
log_info "Log file: ${LOGFILE}"

# ---------------------------
# TENANTS CONFIGURATION
# ---------------------------
TENANTS=(
    "ashantis-munch-mingle"
    "nee-nee-kids"
    "sassie-lash"
    "roro-gamers-lounge"
    "tyshawn-v-dance-studio"
    "club-sadityy"
    "fayeloni-kreations"
    "headwinas-comedy-club"
    "sheda-shay-butter-bar"
    "idf-live"
    "clocking-t-with-ya-gurl-p"
    "gas-or-crash-live"
    "faith-through-fitness"
    "rise-sacramento-916"
    "puaboverse"
    "vscreen-hollywood"
    "nexus-studio-ai"
    "metatwin"
    "musicchain"
    "boom-boom-room"
)

TENANT_PORTS=(
    3040 3042 3043 3032 3030 3020 3040 3042 3043 3021
    3022 3023 3024 3025 3060 8088 3011 3403 3050 3005
)

# ---------------------------
# CORE SERVICES
# ---------------------------
CORE_SERVICES=(
    "frontend:3000:N3XUS STREAM - Platform Entrypoint"
    "gateway:4000:PUABO API Gateway"
    "casino-nexus:9503:Casino-Nexus Core"
    "streaming:3070:Streaming Service (Live/VOD/PPV)"
    "admin:9504:Admin Portal"
    "puaboai-sdk:3002:PUABO AI SDK"
    "pv-keys:3041:PV Keys Service"
    "auth:3001:Auth Service"
    "postgres:5432:PostgreSQL Database"
    "redis:6379:Redis Cache"
)

# ---------------------------
# PREREQUISITES CHECK
# ---------------------------
log_step "STEP 1/12: Prerequisites Validation"
log_info "Checking system requirements..."

# Check sudo/root
if [[ $EUID -ne 0 ]]; then
   log_error "This script must be run as root or with sudo"
   exit 1
fi
log_success "Root access: OK"

# Check Docker
if ! command -v docker &> /dev/null; then
    log_warning "Docker not found. Installing Docker..."
    curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
    sh /tmp/get-docker.sh
    systemctl enable docker
    systemctl start docker
fi
log_success "Docker: OK"

# Check Docker Compose
if ! command -v docker-compose &> /dev/null; then
    log_warning "Docker Compose not found. Installing..."
    curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
fi
log_success "Docker Compose: OK"

# Check disk space (12GB minimum)
AVAILABLE_DISK=$(df / | awk 'NR==2 {print $4}')
if [ "${AVAILABLE_DISK}" -lt 12582912 ]; then
    log_error "Insufficient disk space. Required: 12GB, Available: $((AVAILABLE_DISK / 1024 / 1024))GB"
    exit 1
fi
log_success "Disk Space: OK ($((AVAILABLE_DISK / 1024 / 1024))GB available)"

# Check RAM (6GB minimum)
AVAILABLE_RAM=$(free -m | awk 'NR==2{print $2}')
if [ "${AVAILABLE_RAM}" -lt 6144 ]; then
    log_warning "Low RAM. Required: 6GB, Available: ${AVAILABLE_RAM}MB"
fi
log_success "RAM: OK (${AVAILABLE_RAM}MB available)"

# Check required tools
for cmd in git curl nc nginx; do
    if ! command -v $cmd &> /dev/null; then
        log_warning "$cmd not found. Installing..."
        apt-get update && apt-get install -y $cmd
    fi
    log_success "$cmd: OK"
done

# ---------------------------
# REPOSITORY MANAGEMENT
# ---------------------------
log_step "STEP 2/12: Repository Management"
if [ -d "${NEXUS_REPO_PATH}" ]; then
    log_info "Repository exists. Updating..."
    cd "${NEXUS_REPO_PATH}"
    git stash
    git fetch origin main
    git reset --hard origin/main
    log_success "Repository updated"
else
    log_info "Cloning repository..."
    git clone https://github.com/BobbyBlanco400/nexus-cos.git "${NEXUS_REPO_PATH}"
    cd "${NEXUS_REPO_PATH}"
    log_success "Repository cloned"
fi

if [ ! -f "${NEXUS_REPO_PATH}/docker-compose.final.yml" ]; then
    log_error "docker-compose.final.yml not found in ${NEXUS_REPO_PATH}"
    log_error "Aborting deployment. Ensure the canonical stack file exists."
    exit 1
fi

# ---------------------------
# DATABASE INITIALIZATION
# ---------------------------
log_step "STEP 3/12: Database Initialization"
log_info "Starting PostgreSQL container..."
docker-compose -f docker-compose.final.yml up -d postgres

log_info "Waiting for PostgreSQL to be ready..."
for i in {1..30}; do
    if docker exec nexus-cos-postgres pg_isready -U postgres > /dev/null 2>&1; then
        break
    fi
    sleep 2
done
log_success "PostgreSQL ready"

log_info "Creating database users and databases..."
docker exec nexus-cos-postgres psql -U postgres -c "
CREATE USER IF NOT EXISTS nexus_user WITH SUPERUSER PASSWORD 'nexus_secure_password_2025';
CREATE USER IF NOT EXISTS nexuscos WITH SUPERUSER PASSWORD 'nexus_secure_password_2025';
CREATE DATABASE IF NOT EXISTS nexus_cos OWNER nexus_user;
CREATE DATABASE IF NOT EXISTS nexuscos_db OWNER nexuscos;
" || log_warning "Database creation warnings (may already exist)"

log_info "Initializing 11 Founder Access Keys..."
docker exec nexus-cos-postgres psql -U postgres -d nexus_cos -c "
CREATE TABLE IF NOT EXISTS casino_accounts (
    username VARCHAR(50) PRIMARY KEY,
    password_hash VARCHAR(255) NOT NULL,
    nexcoin_balance NUMERIC(15,2) DEFAULT 0.00,
    role VARCHAR(20) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO casino_accounts (username, password_hash, nexcoin_balance, role) VALUES
('admin_nexus', '\$2b\$10\$ADMIN_HASH', 999999999.99, 'admin'),
('vip_whale_01', '\$2b\$10\$VIP_HASH', 1000000.00, 'vip'),
('vip_whale_02', '\$2b\$10\$VIP_HASH', 1000000.00, 'vip'),
('beta_tester_01', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_02', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_03', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_04', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_05', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_06', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_07', '\$2b\$10\$BETA_HASH', 50000.00, 'beta'),
('beta_tester_08', '\$2b\$10\$BETA_HASH', 50000.00, 'beta')
ON CONFLICT (username) DO NOTHING;

CREATE OR REPLACE FUNCTION maintain_admin_unlimited_balance()
RETURNS TRIGGER AS \$\$
BEGIN
    IF NEW.username = 'admin_nexus' THEN
        NEW.nexcoin_balance := 999999999.99;
    END IF;
    RETURN NEW;
END;
\$\$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS admin_unlimited_balance_trigger ON casino_accounts;
CREATE TRIGGER admin_unlimited_balance_trigger
BEFORE INSERT OR UPDATE ON casino_accounts
FOR EACH ROW EXECUTE FUNCTION maintain_admin_unlimited_balance();
" || log_warning "Founder keys initialization warnings"

log_success "Database initialized with 11 Founder Access Keys"
log_info "Total pre-loaded: 2,400,000 NC + UNLIMITED (admin_nexus)"

# ---------------------------
# PWA INFRASTRUCTURE
# ---------------------------
log_step "STEP 4/12: PWA Infrastructure Setup"
mkdir -p "${NEXUS_REPO_PATH}/frontend/public"

log_info "Creating manifest.json..."
cat > "${NEXUS_REPO_PATH}/frontend/public/manifest.json" << 'EOF'
{
  "name": "NEXUS COS Platform",
  "short_name": "NEXUS",
  "description": "N3XUS STREAM - AI-Fused Control Dashboard",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#6B46C1",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "shortcuts": [
    {
      "name": "Casino Nexus",
      "url": "/puaboverse",
      "description": "9-Card Casino Lounge"
    },
    {
      "name": "VR Lounge",
      "url": "/puaboverse/vr-lounge",
      "description": "NexusVision VR Experience"
    }
  ]
}
EOF

log_info "Creating service-worker.js..."
cat > "${NEXUS_REPO_PATH}/frontend/public/service-worker.js" << 'EOF'
const CACHE_NAME = 'nexus-cos-v2025-1-0';
const urlsToCache = [
  '/',
  '/index.html',
  '/manifest.json',
  '/static/css/main.css',
  '/static/js/main.js'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    fetch(event.request)
      .catch(() => caches.match(event.request))
  );
});
EOF

log_info "Creating pwa-register.js..."
cat > "${NEXUS_REPO_PATH}/frontend/public/pwa-register.js" << 'EOF'
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => console.log('PWA registered'))
    .catch(err => console.error('PWA registration failed:', err));
}
EOF

log_success "PWA infrastructure created"

# ---------------------------
# NGINX CONFIGURATION
# ---------------------------
log_step "STEP 5/12: Nginx Configuration"
log_info "Generating nginx configuration..."

# Build the complete configuration with tenant routes
NGINX_CONFIG=$(cat << 'EOF'
server {
    listen 80;
    server_name n3xuscos.online www.n3xuscos.online;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name n3xuscos.online www.n3xuscos.online;
    
    ssl_certificate /etc/letsencrypt/live/n3xuscos.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/n3xuscos.online/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    
    # N3XUS STREAM - Frontend Entrypoint
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Gateway API
    location /api {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Casino-Nexus Lounge (9 Cards)
    location /puaboverse {
        proxy_pass http://localhost:3060;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Wallet
    location /wallet {
        proxy_pass http://localhost:3000/wallet;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    
    # Streaming (Live/VOD/PPV)
    location ~ ^/(live|vod|ppv) {
        proxy_pass http://localhost:3070;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Health Check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
EOF
)

# Add tenant routes dynamically
for i in "${!TENANTS[@]}"; do
    TENANT="${TENANTS[$i]}"
    PORT="${TENANT_PORTS[$i]}"
    NGINX_CONFIG+="

    # Tenant: ${TENANT}
    location /${TENANT} {
        proxy_pass http://localhost:${PORT};
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
"
done

# Deploy the configuration using safe deployment function
log_info "Deploying nginx configuration with safe backup and validation..."
safe_write_nginx_config "/etc/nginx/sites-available/nexus-master.conf" "$NGINX_CONFIG" "true"

if [[ $? -ne 0 ]]; then
    log_error "Failed to deploy nginx configuration"
    exit 1
fi

# Enable configuration
safe_enable_site "nexus-master.conf" || {
    log_error "Failed to enable nginx site"
    exit 1
}

# Reload nginx
reload_nginx || {
    log_error "Failed to reload nginx"
    exit 1
}

log_success "Nginx configured and reloaded"

# ---------------------------
# NEXUS-HANDSHAKE 55-45-17
# ---------------------------
log_step "STEP 6/12: Nexus-Handshake 55-45-17 Compliance"
log_info "Verifying platform compliance..."

CORE_SCORE=0
FEATURE_SCORE=0
MICROSERVICES_COUNT=0

# Core Platform (55%)
for service in "frontend" "gateway" "postgres" "redis" "puaboai-sdk"; do
    if docker ps | grep -q "$service"; then
        ((CORE_SCORE += 11))
        log_success "Core service: $service âœ“"
    else
        log_warning "Core service missing: $service"
    fi
done

# Feature Layer (45%)
for service in "casino-nexus" "streaming" "puaboverse" "auth"; do
    if docker ps | grep -q "$service"; then
        ((FEATURE_SCORE += 11))
        log_success "Feature service: $service âœ“"
    else
        log_warning "Feature service missing: $service"
    fi
done

# Microservices Count
MICROSERVICES_COUNT=$(docker ps --format '{{.Names}}' | wc -l)
log_info "Microservices running: ${MICROSERVICES_COUNT}/17 minimum"

TOTAL_SCORE=$((CORE_SCORE + FEATURE_SCORE))
log_info "Nexus-Handshake Score: ${TOTAL_SCORE}%"

if [ "${TOTAL_SCORE}" -ge 90 ]; then
    log_success "COMPLIANT (${TOTAL_SCORE}% >= 90%)"
elif [ "${TOTAL_SCORE}" -ge 75 ]; then
    log_warning "PARTIAL COMPLIANCE (${TOTAL_SCORE}% >= 75%)"
else
    log_error "NON-COMPLIANT (${TOTAL_SCORE}% < 75%)"
fi

# ---------------------------
# DOCKER STACK DEPLOYMENT
# ---------------------------
log_step "STEP 7/12: Docker Stack Deployment"
log_info "Starting all services..."
cd "${NEXUS_REPO_PATH}"
docker-compose -f docker-compose.final.yml up -d
log_success "Docker stack deployed"

# ---------------------------
# HEALTH CHECKS
# ---------------------------
log_step "STEP 8/12: Health Check Validation (120s window)"
log_info "Waiting for services to be healthy..."
sleep 30

HEALTHY_COUNT=0
TOTAL_SERVICES=$(echo "${CORE_SERVICES[@]}" | wc -w)

for service_config in "${CORE_SERVICES[@]}"; do
    IFS=':' read -r name port description <<< "$service_config"
    log_info "Checking $description (port $port)..."
    
    if nc -z localhost "$port" 2>/dev/null; then
        ((HEALTHY_COUNT++))
        log_success "$description: healthy"
    else
        log_warning "$description: not responding"
    fi
done

HEALTH_PERCENTAGE=$((HEALTHY_COUNT * 100 / TOTAL_SERVICES))
log_info "Health Status: ${HEALTHY_COUNT}/${TOTAL_SERVICES} services (${HEALTH_PERCENTAGE}%)"

if [ "${HEALTH_PERCENTAGE}" -ge 80 ]; then
    log_success "Health check PASSED"
else
    log_warning "Health check PARTIAL (${HEALTH_PERCENTAGE}% < 80%)"
fi

# ---------------------------
# FEATURE FLAGS
# ---------------------------
log_step "STEP 9/12: Feature Flags Configuration"
mkdir -p "${NEXUS_CONFIG_DIR}"

cat > "${NEXUS_CONFIG_DIR}/feature-flags.json" << EOF
{
  "version": "${NEXUS_VERSION}",
  "timestamp": "$(date -Iseconds)",
  "architecture": {
    "frontend_entrypoint": "N3XUS STREAM - Tony Stark-Level AI-Fused Control Dashboard",
    "casino_entry": "/puaboverse leads to Casino-Nexus Lounge with 9 Cards",
    "vr_system": "NexusVision + HoloCore + StreaCore",
    "connectivity": "Nexus-Net 5G Hybrid"
  },
  "features": {
    "founder_beta": { "enabled": true, "founder_keys": 11 },
    "jurisdiction_engine": { "enabled": true, "regions": ["US", "EU", "ASIA", "GLOBAL"] },
    "marketplace_phase2": { "enabled": true, "trading_enabled": false },
    "ai_dealers": { "enabled": true, "engine": "puabo_ai_hf" },
    "casino_federation": { "enabled": true, "max_casinos": 10 },
    "pwa": { "enabled": true, "offline_cache": true },
    "nexus_vision": { "enabled": true, "vr_ar_streaming": true },
    "holo_core": { "enabled": true, "holographic_ui": true },
    "strea_core": { "enabled": true, "multi_stream": true },
    "nexus_net": { "enabled": true, "5g_hybrid": true }
  },
  "urls": {
    "production": "https://${NEXUS_DOMAIN}",
    "n3xus_stream": "https://${NEXUS_DOMAIN}",
    "casino_lounge": "https://${NEXUS_DOMAIN}/puaboverse",
    "wallet": "https://${NEXUS_DOMAIN}/wallet",
    "live": "https://${NEXUS_DOMAIN}/live",
    "vod": "https://${NEXUS_DOMAIN}/vod",
    "ppv": "https://${NEXUS_DOMAIN}/ppv"
  },
  "tenants": $(printf '%s\n' "${TENANTS[@]}" | jq -R . | jq -s .)
}
EOF

log_success "Feature flags configured"

# ---------------------------
# TENANT URL MATRIX
# ---------------------------
log_step "STEP 10/12: Tenant URL Matrix Generation"
cat > "${NEXUS_REPO_PATH}/docs/TENANT_URL_MATRIX.md" << EOF
# NEXUS MASTER ONE-SHOT: Tenant URL Matrix

**Generated:** $(date '+%Y-%m-%d %H:%M:%S %Z')  
**Version:** ${NEXUS_VERSION}  
**Domain:** ${NEXUS_DOMAIN}

## Core Services (12)

| Service | Port | Production URL | Local URL |
|---------|------|----------------|-----------|
| N3XUS STREAM | 3000 | https://${NEXUS_DOMAIN} | http://localhost:3000 |
| Gateway API | 4000 | https://${NEXUS_DOMAIN}/api | http://localhost:4000 |
| Casino-Nexus Lounge | 3060 | https://${NEXUS_DOMAIN}/puaboverse | http://localhost:3060 |
| Casino-Nexus Core | 9503 | (internal) | http://localhost:9503 |
| Streaming Service | 3070 | https://${NEXUS_DOMAIN}/live | http://localhost:3070 |
| PUABO AI SDK | 3002 | (internal) | http://localhost:3002 |
| PV Keys | 3041 | (internal) | http://localhost:3041 |
| Auth Service | 3001 | (internal) | http://localhost:3001 |
| Admin Portal | 9504 | (internal) | http://localhost:9504 |
| PostgreSQL | 5432 | (internal) | http://localhost:5432 |
| Redis | 6379 | (internal) | http://localhost:6379 |
| Wallet | 3000 | https://${NEXUS_DOMAIN}/wallet | http://localhost:3000/wallet |

## Mini Tenants (${#TENANTS[@]})

| Tenant | Port | Production URL | Description |
|--------|------|----------------|-------------|
EOF

for i in "${!TENANTS[@]}"; do
    TENANT="${TENANTS[$i]}"
    PORT="${TENANT_PORTS[$i]}"
    echo "| ${TENANT} | ${PORT} | https://${NEXUS_DOMAIN}/${TENANT} | Family/Urban Platform |" >> "${NEXUS_REPO_PATH}/docs/TENANT_URL_MATRIX.md"
done

cat >> "${NEXUS_REPO_PATH}/docs/TENANT_URL_MATRIX.md" << EOF

## 9-Card Casino Grid

1. **Slots & Skill Games** - Skill-based gameplay
2. **Table Games** - Blackjack, Poker, Roulette
3. **Live Dealers** - Real-time dealer games
4. **VR Casino** - NexusVision immersive experience
5. **High Roller Suite** - 5K NC minimum entry
6. **Progressive Jackpots** - Utility reward pools
7. **Tournament Hub** - Competitive events
8. **Loyalty Rewards** - Founder tier benefits
9. **Marketplace** - Asset preview (Phase 2)

## Health Checks

- Main: https://${NEXUS_DOMAIN}/health
- Puaboverse: https://${NEXUS_DOMAIN}/puaboverse/health
- Wallet: https://${NEXUS_DOMAIN}/wallet/health

## SSL/TLS Configuration

- Provider: Let's Encrypt
- Certificates: ${NEXUS_SSL_PATH}/fullchain.pem
- Protocols: TLSv1.2, TLSv1.3

---

**Total Services:** $((12 + ${#TENANTS[@]}))  
**Nexus-Handshake:** 55-45-17 Compliant  
**PWA:** Enabled (Offline-First)  
**NexCoin:** 11 Founder Keys (2.4M NC + UNLIMITED)
EOF

log_success "Tenant URL matrix generated"

# ---------------------------
# INTERACTIVE CONTROL PANEL
# ---------------------------
log_step "STEP 11/12: Interactive Control Panel Setup"
log_info "Creating control panel scripts..."

cat > /usr/local/bin/nexus-control << 'CTRLEOF'
#!/bin/bash
# NEXUS Interactive Control Panel

case "$1" in
    status)
        echo "=== NEXUS Platform Status ==="
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        ;;
    logs)
        tail -f /var/log/nexus-cos/nexus-master-*.log
        ;;
    health)
        echo "=== Health Check ==="
        curl -s https://n3xuscos.online/health
        ;;
    restart)
        echo "=== Restarting Services ==="
        cd /var/www/nexus-cos && docker-compose -f docker-compose.final.yml restart
        ;;
    scale)
        echo "=== Scaling Service: $2 to $3 replicas ==="
        docker-compose -f docker-compose.final.yml up -d --scale "$2=$3"
        ;;
    deploy)
        echo "=== Redeploying ==="
        bash /var/www/nexus-cos/NEXUS_MASTER_ONE_SHOT.sh
        ;;
    *)
        echo "NEXUS Control Panel"
        echo "Usage: nexus-control {status|logs|health|restart|scale|deploy}"
        ;;
esac
CTRLEOF

chmod +x /usr/local/bin/nexus-control
log_success "Control panel installed: nexus-control"

# ---------------------------
# DEPLOYMENT SUMMARY
# ---------------------------
log_step "STEP 12/12: Deployment Summary"
log_step "N3XUS LAW 55-45-17 Verification"
if [ -x "${NEXUS_REPO_PATH}/scripts/verify-handshake.sh" ]; then
    cd "${NEXUS_REPO_PATH}" && ./scripts/verify-handshake.sh
fi
if [ -x "${NEXUS_REPO_PATH}/nexus/handshake/verify_55-45-17.sh" ]; then
    cd "${NEXUS_REPO_PATH}" && ./nexus/handshake/verify_55-45-17.sh
fi
log_header "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                           â•‘
â•‘                       ðŸŽ‰ DEPLOYMENT SUCCESSFUL ðŸŽ‰                         â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

log_success "NEXUS MASTER ONE-SHOT deployment completed!"
log_info "Version: ${NEXUS_VERSION}"
log_info "Domain: ${NEXUS_DOMAIN}"
log_info "Total Services: $((12 + ${#TENANTS[@]}))"
log_info "Health Status: ${HEALTHY_COUNT}/${TOTAL_SERVICES} (${HEALTH_PERCENTAGE}%)"
log_info "Nexus-Handshake: ${TOTAL_SCORE}%"
log_info "Log File: ${LOGFILE}"

echo ""
log_header "ðŸŒ PRODUCTION URLS:"
log_info "N3XUS STREAM:        https://${NEXUS_DOMAIN}"
log_info "Casino-Nexus Lounge: https://${NEXUS_DOMAIN}/puaboverse"
log_info "Wallet:              https://${NEXUS_DOMAIN}/wallet"
log_info "Live Streaming:      https://${NEXUS_DOMAIN}/live"
log_info "VOD:                 https://${NEXUS_DOMAIN}/vod"
log_info "PPV:                 https://${NEXUS_DOMAIN}/ppv"

echo ""
log_header "ðŸŽ® CONTROL PANEL:"
log_info "Status:    nexus-control status"
log_info "Logs:      nexus-control logs"
log_info "Health:    nexus-control health"
log_info "Restart:   nexus-control restart"
log_info "Redeploy:  nexus-control deploy"

echo ""
log_header "ðŸ“Š PLATFORM STATS:"
log_info "Core Services:       12"
log_info "Mini Tenants:        ${#TENANTS[@]}"
log_info "Total Microservices: ${MICROSERVICES_COUNT}"
log_info "Founder Keys:        11 (2.4M NC + UNLIMITED)"
log_info "PWA Status:          Enabled (Offline-First)"
log_info "Nexus-Vision:        Enabled (VR/AR Streaming)"
log_info "5G Hybrid:           Enabled (Nexus-Net)"

echo ""
log_header "ðŸ”’ SECURITY NOTES:"
log_warning "Change default passwords immediately!"
log_info "Database: nexus_user / nexus_secure_password_2025"
log_info "Founder Keys: WelcomeToVegas_25 (VIP/Beta)"
log_info "Admin: admin_nexus_2025"

echo ""
log_success "ðŸš€ NEXUS MASTER ONE-SHOT: Tony Stark-Level AI-Fused Control Dashboard is LIVE!"
log_info "Documentation: ${NEXUS_REPO_PATH}/docs/TENANT_URL_MATRIX.md"
log_info "Feature Flags: ${NEXUS_CONFIG_DIR}/feature-flags.json"

# Cleanup
rm -f "${LOCKFILE}"

exit 0
