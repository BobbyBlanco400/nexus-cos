name: NÎž3XUSÂ·COS Full Platform Activation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  activate:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load PF Master Configuration
        run: |
          test -f pf-master.yaml || exit 1
          test -f pf-master-comprehensive.yaml || exit 1
          echo "âœ… PF configurations loaded"

      - name: Validate Inventory
        run: |
          grep "services: 78" pf-master.yaml
          grep "tenants: 12" pf-master.yaml
          echo "âœ… Inventory validated"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build All Services
        run: |
          echo "ðŸ”¨ Building all service images..."
          docker compose build
          echo "âœ… All services built"

      - name: Run N.E.X.U.S AI Verification Suite
        run: |
          echo "ðŸ” Running verification suite..."
          chmod +x nexus-ai/verify/*.sh
          ./nexus-ai/verify/run-all.sh
          echo "âœ… All verifications passed"

      - name: Deploy Tier 0 - Foundation
        run: |
          echo "ðŸš€ Deploying Tier 0: Foundation Services"
          docker compose up -d postgres redis streamcore puabo-api auth-service pv-keys puaboai-sdk
          echo "âœ… Tier 0 deployed"

      - name: Wait For Tier 0 Health
        run: |
          echo "â³ Waiting for Tier 0 health..."
          ./scripts/verify-tier.sh tier_0 || exit 1
          echo "âœ… Tier 0 healthy"
        timeout-minutes: 5

      - name: Deploy Tier 1 - Economic Core
        run: |
          echo "ðŸš€ Deploying Tier 1: Economic Core"
          docker compose up -d ledger-mgr wallet-ms token-mgr invoice-gen
          echo "âœ… Tier 1 deployed"

      - name: Verify Economic Enforcement
        run: |
          echo "â³ Verifying ledger and platform fee enforcement..."
          ./scripts/verify-ledger.sh || exit 1
          echo "âœ… Economic enforcement verified"

      - name: Deploy Tier 2 - Platform Services
        run: |
          echo "ðŸš€ Deploying Tier 2: Platform Services"
          docker compose up -d license-service musicchain-ms puabomusicchain dsp-api content-management
          echo "âœ… Tier 2 deployed"

      - name: Deploy Tier 3 - Streaming Extensions
        run: |
          echo "ðŸš€ Deploying Tier 3: Streaming Extensions"
          docker compose up -d streaming-service-v2 chat-stream-ms ott-api
          echo "âœ… Tier 3 deployed"

      - name: Deploy Tier 4 - Virtual Casino & AI
        run: |
          echo "ðŸš€ Deploying Tier 4: Virtual Casino & AI"
          docker compose up -d avatar-ms world-engine-ms gamecore-ms casino-nexus-api rewards-ms skill-games-ms puabo-nexus-ai-dispatch
          echo "âœ… Tier 4 deployed"

      - name: Deploy N.E.X.U.S AI Control Panel
        run: |
          echo "ðŸš€ Deploying N.E.X.U.S AI Control Panel"
          cd nexus-ai/control-panel
          npm install --production
          # Start as background service
          nohup npm start > control-panel.log 2>&1 &
          echo $! > control-panel.pid
          cd ../..
          echo "âœ… N.E.X.U.S AI Control Panel deployed"

      - name: Final System Verification
        run: |
          echo "ðŸ” Running final system verification..."
          ./scripts/verify-all.sh || exit 1
          echo "âœ… All systems operational"

      - name: Verify Casino Grid (9+ Slots)
        run: |
          echo "ðŸ” Verifying casino grid..."
          ./nexus-ai/verify/verify-casino-grid.sh
          echo "âœ… Casino grid verified"

      - name: Verify NexCoin Enforcement
        run: |
          echo "ðŸ” Verifying NexCoin enforcement..."
          ./nexus-ai/verify/verify-nexcoin.sh
          echo "âœ… NexCoin enforcement verified"

      - name: Verify Federation Architecture
        run: |
          echo "ðŸ” Verifying federation architecture..."
          ./nexus-ai/verify/verify-federation.sh
          echo "âœ… Federation verified"

      - name: Generate Deployment Report
        run: |
          echo "ðŸ“Š Generating deployment report..."
          cat > deployment-report.md << EOF
          # Deployment Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Environment:** ${{ github.event.inputs.environment }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## Services Deployed
          - Tier 0: Foundation (7 services)
          - Tier 1: Economic Core (4 services)
          - Tier 2: Platform Services (5 services)
          - Tier 3: Streaming Extensions (3 services)
          - Tier 4: Virtual Casino & AI (7 services)
          - N.E.X.U.S AI Control Panel (1 service)
          
          **Total Services:** 27+ (with 12 tenant instances)
          
          ## Verification Status
          - âœ… Handshake: PASSED
          - âœ… Casino Grid: PASSED
          - âœ… NexCoin: PASSED
          - âœ… Federation: PASSED
          - âœ… Tenant Isolation: PASSED
          - âœ… Economic Enforcement: PASSED
          
          ## Deployment Status
          ðŸŽ‰ **ALL SYSTEMS OPERATIONAL**
          EOF
          
          cat deployment-report.md
          echo "âœ… Deployment report generated"

      - name: Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "ðŸŽ‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŽ‰  N.E.X.U.S COS FULL ACTIVATION COMPLETE   "
          echo "ðŸŽ‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… All tiers deployed and verified"
          echo "âœ… N.E.X.U.S AI Control Panel active"
          echo "âœ… All verifications passing"
          echo "âœ… Platform ready for production traffic"
          echo ""
          echo "ðŸ“¡ Control Panel: http://localhost:9000"
          echo "ðŸŒ Production: https://n3xuscos.online"

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed - initiating rollback"
          ./scripts/rollback.sh
          exit 1
