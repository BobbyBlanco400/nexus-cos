name: Deploy to Sovereign VPS

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'docker-compose.full.yml'
      - 'launch_vps_stack.sh'
      - '.github/workflows/deploy-sovereign.yml'

jobs:
  deploy:
    name: ðŸ¦… Sovereign Launch
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Verify Notarization
      run: |
        if [ ! -f "NOTARIZED_DIGITAL_COPY.md" ]; then
          echo "âŒ Notarization missing! Deployment Aborted."
          exit 1
        fi
        echo "âœ… Notarization Verified."

    - name: Deploy to Hostinger
      id: deploy
      env:
        SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      run: |
        if [ -z "$SSH_KEY" ]; then
          echo "âš ï¸  SSH Key not found in secrets.VPS_SSH_KEY"
          echo "â­ï¸  Skipping automated deployment."
          exit 1
        fi

        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        echo "ðŸš€ Connecting to Sovereign VPS (72.62.86.217)..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@72.62.86.217 << 'EOF'
          cd /root/nexus-cos || git clone https://github.com/BobbyBlanco400/nexus-cos.git /root/nexus-cos
          cd /root/nexus-cos
          git checkout main
          git pull origin main
          chmod +x launch_vps_stack.sh
          ./launch_vps_stack.sh
        EOF
      continue-on-error: true

    - name: Deployment Status
      if: steps.deploy.outcome != 'success'
      run: |
        echo "âš ï¸  AUTOMATED DEPLOYMENT SKIPPED OR FAILED"
        echo "ðŸ“ MANUAL ACTION REQUIRED:"
        echo "1. SSH into 72.62.86.217"
        echo "2. Run: cd /root/nexus-cos && git pull && ./launch_vps_stack.sh"
