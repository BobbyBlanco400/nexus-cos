name: ğŸ”´ Handshake 55-45-17 Enforcement

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  enforce-handshake:
    name: ğŸ”´ Enforce N3XUS Handshake
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”´ Set Genesis Lock Environment
        run: |
          echo "NEXUS_HANDSHAKE=55-45-17" >> $GITHUB_ENV
          echo "GENESIS_LOCK_ENABLED=true" >> $GITHUB_ENV
          echo "ğŸ”´ Environment configured for Genesis Lock"
      
      - name: ğŸ”´ Verify Genesis Lock Files
        run: |
          echo "ğŸ”´ Checking Genesis Lock files..."
          
          if [ ! -f "core/genesis-lock/lock.enabled" ]; then
            echo "âŒ Genesis Lock not enabled"
            exit 1
          fi
          
          if [ ! -f "core/genesis-lock/genesis-lock-validator.sh" ]; then
            echo "âŒ Genesis Lock validator missing"
            exit 1
          fi
          
          echo "âœ… Genesis Lock files verified"
      
      - name: ğŸ”´ Run Handshake Enforcer
        run: |
          echo "ğŸ”´ Running N3XUS Handshake Enforcer..."
          chmod +x nexus-handshake-enforcer.sh
          export NEXUS_HANDSHAKE="55-45-17"
          export GENESIS_LOCK_ENABLED="true"
          ./nexus-handshake-enforcer.sh || exit 1
          echo "âœ… Handshake enforcement passed"
      
      - name: ğŸ”´ Run Genesis Lock Validator
        run: |
          echo "ğŸ”´ Running Genesis Lock Validator..."
          chmod +x core/genesis-lock/genesis-lock-validator.sh
          export NEXUS_HANDSHAKE="55-45-17"
          export GENESIS_LOCK_ENABLED="true"
          ./core/genesis-lock/genesis-lock-validator.sh || exit 1
          echo "âœ… Genesis Lock validation passed"
      
      - name: ğŸ”´ Validate Tenant Count
        run: |
          echo "ğŸ”´ Validating tenant count..."
          
          if [ ! -f "nexus/tenants/canonical_tenants.json" ]; then
            echo "âŒ Tenant registry not found"
            exit 1
          fi
          
          TENANT_COUNT=$(grep -o '"id"' nexus/tenants/canonical_tenants.json | wc -l)
          
          if [ "$TENANT_COUNT" -ne 13 ]; then
            echo "âŒ Expected 13 tenants, found $TENANT_COUNT"
            exit 1
          fi
          
          echo "âœ… Tenant count validated: 13"
      
      - name: ğŸ”´ Validate Revenue Split
        run: |
          echo "ğŸ”´ Validating revenue split..."
          
          if ! grep -q '"split": "80/20"' nexus/tenants/canonical_tenants.json; then
            echo "âŒ Revenue split not set to 80/20"
            exit 1
          fi
          
          echo "âœ… Revenue split validated: 80/20"
      
      - name: ğŸ”´ Validate Governance Charter
        run: |
          echo "ğŸ”´ Validating governance charter..."
          
          if [ ! -f "GOVERNANCE_CHARTER_55_45_17.md" ]; then
            echo "âŒ Governance charter missing"
            exit 1
          fi
          
          if ! grep -q "55-45-17" GOVERNANCE_CHARTER_55_45_17.md; then
            echo "âŒ Handshake not found in governance charter"
            exit 1
          fi
          
          echo "âœ… Governance charter validated"
      
      - name: ğŸ”´ Validate Master PR Documentation
        run: |
          echo "ğŸ”´ Validating Master PR documentation..."
          
          if [ ! -f "N3XUS_vCOS_MasterPR_FullStack_Launch.md" ]; then
            echo "âŒ Master PR documentation missing"
            exit 1
          fi
          
          if ! grep -q "55-45-17" N3XUS_vCOS_MasterPR_FullStack_Launch.md; then
            echo "âŒ Handshake not found in Master PR documentation"
            exit 1
          fi
          
          echo "âœ… Master PR documentation validated"
      
      - name: ğŸ”´ Validate Codespaces Configuration
        run: |
          echo "ğŸ”´ Validating Codespaces configuration..."
          
          if [ ! -f ".devcontainer/devcontainer.json" ]; then
            echo "âŒ Codespaces configuration missing"
            exit 1
          fi
          
          if ! grep -q "55-45-17" .devcontainer/devcontainer.json; then
            echo "âŒ Handshake not found in Codespaces config"
            exit 1
          fi
          
          echo "âœ… Codespaces configuration validated"
      
      - name: ğŸ”´ Final Enforcement Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… HANDSHAKE ENFORCEMENT COMPLETE                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Status Summary:"
          echo "  âœ… Handshake: 55-45-17 ENFORCED"
          echo "  âœ… Genesis Lock: ACTIVE"
          echo "  âœ… Tenants: 13 VERIFIED"
          echo "  âœ… Revenue Split: 80/20 LOCKED"
          echo "  âœ… Governance: COMPLIANT"
          echo "  âœ… Documentation: VALIDATED"
          echo "  âœ… Codespaces: CONFIGURED"
          echo ""
          echo "ğŸ”´ System safety mechanism: ENGAGED"
          echo "ğŸ”´ Silent failure mode: ENABLED"
          echo ""
