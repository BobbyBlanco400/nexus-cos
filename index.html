<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N3XUS v-COS | REMOTE MIC BRIDGE</title>
    <style>
        :root { --neon-blue: #00fffc; --neon-pink: #fc00ff; --dark-bg: #000; --terminal-green: #00ff00; }
        body { background: var(--dark-bg); color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .glitch { font-size: 4rem; font-weight: bold; text-transform: uppercase; text-shadow: 2px 2px var(--neon-blue), -2px -2px var(--neon-pink); animation: pulse 2s infinite; }
        .controls { display: flex; gap: 20px; margin-top: 2rem; }
        .btn { background: transparent; border: 2px solid var(--neon-blue); color: var(--neon-blue); padding: 15px 30px; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        .btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }
        #mic-monitor { width: 300px; height: 20px; border: 1px solid var(--neon-blue); margin-top: 2rem; }
        #mic-level { height: 100%; width: 0%; background: var(--terminal-green); transition: width 0.1s; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    </style>
</head>
<body>
    <div style="text-align: center;">
        <h1 class="glitch">REMOTE MIC BRIDGE</h1>
        <div class="controls" style="flex-direction: column; align-items: center;">
            <div style="margin-bottom: 10px;">
                <select id="audioSource" class="btn" style="border-color: #fff; color: #fff; max-width: 300px; padding: 10px;">
                    <option value="">Detecting Microphones...</option>
                </select>
                <button class="btn" style="padding: 10px;" onclick="getDevices()">â†»</button>
            </div>
            <div style="display: flex; gap: 20px;">
                <button class="btn" onclick="initAudio()">1. START SYSTEM</button>
                <button class="btn" style="border-color: var(--neon-pink); color: var(--neon-pink);" onclick="connectMic()">2. CONNECT SELECTED MIC</button>
            </div>
        </div>
        <div id="status" style="margin-top: 1rem; color: #aaa;">READY FOR HANDSHAKE</div>
        <div id="mic-monitor"><div id="mic-level"></div></div>
    </div>

    <script>
        let audioCtx, analyzer;
        
        async function getDevices() {
            try {
                // Request permission first to ensure we get labels
                await navigator.mediaDevices.getUserMedia({ audio: true }).then(s => s.getTracks().forEach(t => t.stop())).catch(e => console.log("Perm check"));
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioSelect = document.getElementById('audioSource');
                audioSelect.innerHTML = '';
                
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                if (audioInputs.length === 0) {
                     const option = document.createElement('option');
                     option.text = "No microphones found";
                     audioSelect.appendChild(option);
                     return;
                }

                audioInputs.forEach(deviceInfo => {
                    const option = document.createElement('option');
                    option.value = deviceInfo.deviceId;
                    option.text = deviceInfo.label || `Microphone ${audioSelect.length + 1}`;
                    audioSelect.appendChild(option);
                });
            } catch (e) {
                console.error("Error fetching devices:", e);
                const audioSelect = document.getElementById('audioSource');
                audioSelect.innerHTML = '<option>Error detecting devices</option>';
            }
        }
        
        window.onload = getDevices;

        async function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.getElementById('status').innerText = "SYSTEM ONLINE - WAITING FOR MIC";
            // Refresh devices in case permissions changed
            getDevices();
        }
        async function connectMic() {
            if (!audioCtx) await initAudio();
            
            const audioSource = document.getElementById('audioSource').value;
            const constraints = {
                audio: { deviceId: audioSource ? { exact: audioSource } : undefined }
            };
            
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            const source = audioCtx.createMediaStreamSource(stream);
            
            // SHURE MV7 PROCESSING
            const hp = audioCtx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 80;
            const boost = audioCtx.createBiquadFilter(); boost.type = 'peaking'; boost.frequency.value = 3000; boost.gain.value = 3;
            const comp = audioCtx.createDynamicsCompressor(); comp.threshold.value = -24; comp.ratio.value = 3;
            
            analyzer = audioCtx.createAnalyser();
            source.connect(hp).connect(boost).connect(comp).connect(analyzer);
            
            document.getElementById('status').innerText = "MIC CONNECTED - BROADCASTING";
            updateLevel();
            
            // Auto-redirect to Prompter Lite on same host
            const host = window.location.hostname;
            setTimeout(() => { 
                if(confirm("Bridge Active. Switch to Prompter Lite?")) {
                    window.location.href = `http://${host}:3504`; 
                }
            }, 1500);
        }
        function updateLevel() {
            const data = new Uint8Array(analyzer.frequencyBinCount);
            analyzer.getByteFrequencyData(data);
            let avg = data.reduce((a, b) => a + b) / data.length;
            document.getElementById('mic-level').style.width = (avg * 1.5) + "%";
            requestAnimationFrame(updateLevel);
        }
    </script>
</body>
</html>
