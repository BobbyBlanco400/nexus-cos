version: '3.9'

# Phase 5 Master PR: Runtime Core Activation
# N3XUS Handshake 55-45-17 ENFORCED at ALL layers
# No Handshake → No Build → No Boot → No Service

services:
  # 1️⃣ v-supercore: Sovereign Runtime Brain / Governance Authority
  # Stack: FastAPI + Uvicorn
  # Role: Enforce N3XUS Law, validate handshake, root authority
  v-supercore:
    build:
      context: ./services/v-supercore
      args:
        X_N3XUS_HANDSHAKE: "55-45-17"
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: v-supercore-phase5
    ports:
      - "3001:8080"
    environment:
      - X_N3XUS_HANDSHAKE=55-45-17
      - N3XUS_HANDSHAKE=55-45-17
      - NEXUS_HANDSHAKE=55-45-17
      - PORT=8080
      - HOST=0.0.0.0
      - PYTHONUNBUFFERED=1
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # 2️⃣ puabo_api_ai_hf: AI / Inference Gateway
  # Stack: Node.js + Express
  # Role: Handshake-gated AI access, future inference routing
  puabo_api_ai_hf:
    build:
      context: ./services/puabo_api_ai_hf
      args:
        X_N3XUS_HANDSHAKE: "55-45-17"
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: puabo-api-ai-hf-phase5
    ports:
      - "3002:3401"
    environment:
      - X_N3XUS_HANDSHAKE=55-45-17
      - N3XUS_HANDSHAKE=55-45-17
      - NEXUS_HANDSHAKE=55-45-17
      - PORT=3401
      - HOST=0.0.0.0
      - NODE_ENV=production
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3401/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # 3. holofabric-runtime: Sovereign Spatial Runtime
  # NOW LINKED TO: n3xus-holofabric-core (Canonical)
  holofabric-runtime:
    build:
      context: ./n3xus-holofabric-core/apps/runtime
      args:
        X_N3XUS_HANDSHAKE: "55-45-17"
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: holofabric-runtime-phase5
    ports:
      - "3700:3700"
    environment:
      - X_N3XUS_HANDSHAKE=55-45-17
      - N3XUS_HANDSHAKE=55-45-17
      - NEXUS_HANDSHAKE=55-45-17
      - PORT=3700
      - HOST=0.0.0.0
      - NODE_ENV=production
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3700/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Legacy services retained for backward compatibility
  # Will be migrated in future phases
  ledger-mgr:
    build: ./services/ledger-mgr
    container_name: ledger-mgr
    ports:
      - "3112:3112"
    environment:
      - NODE_ENV=production
      - X_N3XUS_HANDSHAKE=55-45-17
    networks:
      - nexus-network

  founding-creatives:
    build: ./founding-creatives
    container_name: founding-creatives
    ports:
      - "3200:3200"
    environment:
      - NODE_ENV=production
      - X_N3XUS_HANDSHAKE=55-45-17
      - PORT=3200
    networks:
      - nexus-network

  puabo-nexus-driver-app-backend:
    build: ./services/puabo-nexus-driver-app-backend
    container_name: puabo-nexus-driver-app-backend
    ports:
      - "3301:3000"
    environment:
      - NODE_ENV=production
      - X_N3XUS_HANDSHAKE=55-45-17
    networks:
      - nexus-network

  puaboverse-v2:
    build: ./services/puaboverse-v2
    container_name: puaboverse-v2
    ports:
      - "3400:3000"
    environment:
      - NODE_ENV=production
      - X_N3XUS_HANDSHAKE=55-45-17
    networks:
      - nexus-network

  puabo-nuki-inventory-mgr:
    build: ./services/puabo-nuki-inventory-mgr
    container_name: puabo-nuki-inventory-mgr
    ports:
      - "3500:3000"
    environment:
      - NODE_ENV=production
      - X_N3XUS_HANDSHAKE=55-45-17
    networks:
      - nexus-network

  puabo-dsp-metadata-mgr:
    build: ./services/puabo-dsp-metadata-mgr
    container_name: puabo-dsp-metadata-mgr
    ports:
      - "3600:3000"
    environment:
      - NODE_ENV=production
      - X_N3XUS_HANDSHAKE=55-45-17
    networks:
      - nexus-network

  # ===== NUISANCE SERVICES =====
  # Payment, Jurisdiction, Responsible Gaming, Legal Entity, Explicit Opt-In

  payment-partner:
    build:
      context: ./services/nuisance/payment-partner
      args:
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: payment-partner-codespaces
    environment:
      - N3XUS_HANDSHAKE=55-45-17
      - PORT=4001
    ports:
      - "4001:4001"
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  jurisdiction-rules:
    build:
      context: ./services/nuisance/jurisdiction-rules
      args:
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: jurisdiction-rules-codespaces
    environment:
      - N3XUS_HANDSHAKE=55-45-17
      - PORT=4002
    ports:
      - "4002:4002"
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  responsible-gaming:
    build:
      context: ./services/nuisance/responsible-gaming
      args:
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: responsible-gaming-codespaces
    environment:
      - N3XUS_HANDSHAKE=55-45-17
      - PORT=4003
    ports:
      - "4003:4003"
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  legal-entity:
    build:
      context: ./services/nuisance/legal-entity
      args:
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: legal-entity-codespaces
    environment:
      - N3XUS_HANDSHAKE=55-45-17
      - PORT=4004
    ports:
      - "4004:4004"
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  explicit-opt-in:
    build:
      context: ./services/nuisance/explicit-opt-in
      args:
        N3XUS_HANDSHAKE: "55-45-17"
    container_name: explicit-opt-in-codespaces
    environment:
      - N3XUS_HANDSHAKE=55-45-17
      - PORT=4005
    ports:
      - "4005:4005"
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# Named network with explicit configuration
networks:
  nexus-network:
    driver: bridge
    name: nexus-phase5-network
