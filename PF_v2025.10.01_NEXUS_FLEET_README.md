# PF v2025.10.01 - PUABO NEXUS Fleet Services

## Overview

This document describes the PUABO NEXUS Fleet Management System deployment as part of PF v2025.10.01. The fleet consists of 4 microservices that handle AI-powered dispatch, driver management, fleet operations, and route optimization.

---

## Architecture

### Service Architecture

The PUABO NEXUS fleet uses a hybrid deployment model:

1. **Core PF Stack** (`docker-compose.pf.yml`) - Internal services on Docker network
2. **NEXUS Fleet Stack** (`docker-compose.pf.nexus.yml`) - Fleet services exposed on localhost
3. **Host Nginx** - Reverse proxy to fleet services via localhost ports

### Why Localhost Ports?

Host Nginx cannot resolve Docker service names directly. By exposing services on `127.0.0.1:9001-9004`, we enable reliable proxying from host Nginx to Docker containers.

```
┌─────────────────────────────────────────────────────────────┐
│  External Traffic (HTTPS)                                   │
│  https://nexuscos.online/puabo-nexus/dispatch/health       │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  Host Nginx                                                  │
│  Proxies to 127.0.0.1:9001-9004                            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  Docker Containers (nexus-network)                          │
│  - ai-dispatch:8080        → 127.0.0.1:9001               │
│  - driver-backend:8080     → 127.0.0.1:9002               │
│  - fleet-manager:8080      → 127.0.0.1:9003               │
│  - route-optimizer:8080    → 127.0.0.1:9004               │
└─────────────────────────────────────────────────────────────┘
```

---

## Services

### 1. AI Dispatch (Port 9001)
- **Container Port:** 8080
- **Host Port:** 127.0.0.1:9001
- **Public URL:** `https://nexuscos.online/puabo-nexus/dispatch`
- **Health:** `https://nexuscos.online/puabo-nexus/dispatch/health`
- **Purpose:** AI-powered dispatch engine, real-time route allocation, driver matching

### 2. Driver Backend (Port 9002)
- **Container Port:** 8080
- **Host Port:** 127.0.0.1:9002
- **Public URL:** `https://nexuscos.online/puabo-nexus/driver`
- **Health:** `https://nexuscos.online/puabo-nexus/driver/health`
- **Purpose:** Driver authentication, job notifications, status tracking

### 3. Fleet Manager (Port 9003)
- **Container Port:** 8080
- **Host Port:** 127.0.0.1:9003
- **Public URL:** `https://nexuscos.online/puabo-nexus/fleet`
- **Health:** `https://nexuscos.online/puabo-nexus/fleet/health`
- **Purpose:** Vehicle inventory, maintenance scheduling, fleet analytics

### 4. Route Optimizer (Port 9004)
- **Container Port:** 8080
- **Host Port:** 127.0.0.1:9004
- **Public URL:** `https://nexuscos.online/puabo-nexus/routes`
- **Health:** `https://nexuscos.online/puabo-nexus/routes/health`
- **Purpose:** ML-based route optimization, traffic analysis, cost reduction

---

## Deployment

### Quick Deployment

```bash
# Run the hybrid deployment script
bash scripts/deploy_hybrid_fullstack_pf.sh
```

This script will:
1. ✅ Create shared Docker network (`nexus-network`)
2. ✅ Deploy core PF stack (`docker-compose.pf.yml`)
3. ✅ Deploy NEXUS fleet stack (`docker-compose.pf.nexus.yml`)
4. ✅ Install Nginx routes for fleet services
5. ✅ Validate health endpoints
6. ✅ Test external access

### Manual Deployment

#### Step 1: Create Network
```bash
docker network create nexus-network
```

#### Step 2: Deploy Core Stack
```bash
docker compose -f docker-compose.pf.yml up -d
```

#### Step 3: Deploy NEXUS Fleet
```bash
export NETWORK_NAME=nexus-network
export DOMAIN=nexuscos.online
docker compose -f docker-compose.pf.nexus.yml up -d
```

#### Step 4: Configure Nginx
```bash
sudo bash scripts/update-nginx-puabo-nexus-routes.sh
```

---

## Environment Variables

### Required Variables (in `.env.pf`)

```bash
# Database
DB_HOST=nexus-cos-postgres
DB_PORT=5432
DB_NAME=nexus_db
DB_USER=nexus_user
DB_PASSWORD=your_secure_password

# Redis
REDIS_HOST=nexus-cos-redis
REDIS_PORT=6379

# Security
JWT_SECRET=your_jwt_secret
```

### Optional Variables

```bash
# Network Configuration
NETWORK_NAME=nexus-network
DOMAIN=nexuscos.online

# Custom Container Images
AI_DISPATCH_IMAGE=puabo/nexus-ai-dispatch:latest
DRIVER_BACKEND_IMAGE=puabo/nexus-driver-backend:latest
FLEET_MANAGER_IMAGE=puabo/nexus-fleet-manager:latest
ROUTE_OPTIMIZER_IMAGE=puabo/nexus-route-optimizer:latest
```

---

## Health Checks

### Internal Health Checks (from VPS)

```bash
# AI Dispatch
curl http://127.0.0.1:9001/health

# Driver Backend
curl http://127.0.0.1:9002/health

# Fleet Manager
curl http://127.0.0.1:9003/health

# Route Optimizer
curl http://127.0.0.1:9004/health
```

### External Health Checks (from anywhere)

```bash
# AI Dispatch
curl -I https://nexuscos.online/puabo-nexus/dispatch/health

# Driver Backend
curl -I https://nexuscos.online/puabo-nexus/driver/health

# Fleet Manager
curl -I https://nexuscos.online/puabo-nexus/fleet/health

# Route Optimizer
curl -I https://nexuscos.online/puabo-nexus/routes/health
```

Expected response: `HTTP/2 200`

---

## Nginx Configuration

### Automatic Configuration

The deployment script automatically configures Nginx by running:

```bash
sudo bash scripts/update-nginx-puabo-nexus-routes.sh
```

This script:
1. ✅ Backs up existing Nginx config
2. ✅ Inserts PUABO NEXUS location blocks
3. ✅ Validates configuration with `nginx -t`
4. ✅ Reloads Nginx gracefully

### Manual Configuration

If you need to manually configure Nginx, add these location blocks to your server configuration:

```nginx
# AI Dispatch Service
location /puabo-nexus/dispatch {
    proxy_pass http://127.0.0.1:9001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Driver Backend Service
location /puabo-nexus/driver {
    proxy_pass http://127.0.0.1:9002;
    # ... (same proxy headers)
}

# Fleet Manager Service
location /puabo-nexus/fleet {
    proxy_pass http://127.0.0.1:9003;
    # ... (same proxy headers)
}

# Route Optimizer Service
location /puabo-nexus/routes {
    proxy_pass http://127.0.0.1:9004;
    # ... (same proxy headers)
}
```

---

## Monitoring

### View Logs

```bash
# All fleet services
docker compose -f docker-compose.pf.nexus.yml logs -f

# Specific service
docker compose -f docker-compose.pf.nexus.yml logs -f ai-dispatch
docker compose -f docker-compose.pf.nexus.yml logs -f driver-backend
docker compose -f docker-compose.pf.nexus.yml logs -f fleet-manager
docker compose -f docker-compose.pf.nexus.yml logs -f route-optimizer
```

### Check Service Status

```bash
# All services
docker compose -f docker-compose.pf.nexus.yml ps

# Check running containers
docker ps | grep puabo-nexus
```

### Resource Usage

```bash
docker stats $(docker compose -f docker-compose.pf.nexus.yml ps -q)
```

---

## Troubleshooting

### Services Not Starting

```bash
# Check logs
docker compose -f docker-compose.pf.nexus.yml logs

# Rebuild and restart
docker compose -f docker-compose.pf.nexus.yml down
docker compose -f docker-compose.pf.nexus.yml up -d --build
```

### Health Checks Failing

```bash
# Test internal ports
curl -v http://127.0.0.1:9001/health
curl -v http://127.0.0.1:9002/health
curl -v http://127.0.0.1:9003/health
curl -v http://127.0.0.1:9004/health

# Check if ports are listening
netstat -tulpn | grep -E '9001|9002|9003|9004'
```

### Nginx 502 Bad Gateway

```bash
# Check if services are running
docker compose -f docker-compose.pf.nexus.yml ps

# Test internal connectivity
curl http://127.0.0.1:9001/health

# Check Nginx configuration
sudo nginx -t

# Check Nginx logs
sudo tail -f /var/log/nginx/error.log
```

### Network Issues

```bash
# Verify network exists
docker network inspect nexus-network

# Check which containers are connected
docker network inspect nexus-network | grep -A 5 Containers
```

---

## Testing

### Run Comprehensive Tests

```bash
./test-pf-v2025.10.01-nexus-fleet.sh
```

This test suite validates:
- ✅ Required files exist
- ✅ Docker Compose syntax
- ✅ Service definitions
- ✅ Port mappings
- ✅ Deploy script configuration
- ✅ Nginx route configuration
- ✅ Script syntax
- ✅ Documentation updates

---

## Maintenance

### Update Services

```bash
# Pull latest images
docker compose -f docker-compose.pf.nexus.yml pull

# Restart services
docker compose -f docker-compose.pf.nexus.yml up -d
```

### Backup Configuration

Nginx configurations are automatically backed up to `/etc/nginx/backups/` when running the route updater script.

### Scale Services

To scale a specific service (if needed):

```bash
docker compose -f docker-compose.pf.nexus.yml up -d --scale ai-dispatch=2
```

**Note:** Scaling requires load balancing configuration.

---

## Security Notes

⚠️ **Important for Production:**

1. **Environment Variables**
   - Store sensitive data in `.env.pf`
   - Never commit secrets to version control
   - Use strong, unique passwords

2. **Network Security**
   - Services only exposed on `127.0.0.1` (localhost)
   - External access only through Nginx with HTTPS
   - Configure firewall rules appropriately

3. **SSL/TLS**
   - Ensure valid SSL certificates are in place
   - Configure HSTS headers
   - Use strong cipher suites

4. **Access Control**
   - Implement authentication for all endpoints
   - Use JWT tokens for API access
   - Rate limiting recommended

---

## Support

### Documentation
- [PF_v2025.10.01.md](./PF_v2025.10.01.md) - Complete PF documentation
- [PF_INDEX.md](./PF_INDEX.md) - Master deployment index
- [PF_v2025.10.01_QUICKSTART.md](./PF_v2025.10.01_QUICKSTART.md) - Quick start guide

### Scripts
- `scripts/deploy_hybrid_fullstack_pf.sh` - Main deployment script
- `scripts/update-nginx-puabo-nexus-routes.sh` - Nginx route installer
- `test-pf-v2025.10.01-nexus-fleet.sh` - Test suite

### Contact
For issues or questions, refer to the main Nexus COS documentation or contact the development team.

---

**Last Updated:** 2025-10-08  
**Version:** PF v2025.10.01  
**Status:** ✅ Production Ready
