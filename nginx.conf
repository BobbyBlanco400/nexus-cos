events {}

http {
    # N3XUS v-COS Governance: Handshake 55-45-17 (REQUIRED)
    # This header is injected on all proxied requests for governance enforcement
    # Network: n3xus-net (Sovereign Architecture)
    proxy_set_header X-N3XUS-Handshake "55-45-17";
    
    # n3xus-net Internal Service Upstreams (v- prefix denotes virtual/sovereign services)
    upstream v_stream {
        server v-stream:3000;  # Main streaming service
    }
    
    upstream v_auth {
        server v-auth:4000;  # Authentication & identity
    }
    
    upstream v_platform {
        server v-platform:4001;  # Core platform API
    }
    
    upstream v_suite {
        server v-suite:4100;  # Creative tools suite
    }
    
    upstream v_content {
        server v-content:4200;  # Content management
    }
    
    upstream holofabric_runtime {
        server holofabric-runtime:3700;  # Internal HOLOFABRIC spatial runtime
    }
    
    # Legacy PF Service Upstreams - Exact container names from docker-compose.pf.yml
    # (Maintained for backward compatibility during migration)
    upstream pf_gateway {
        server puabo-api:4000;
    }

    upstream pf_puaboai_sdk {
        server nexus-cos-puaboai-sdk:3002;
    }

    upstream pf_pv_keys {
        server nexus-cos-pv-keys:3041;
    }

    upstream vscreen_hollywood {
        server vscreen-hollywood:8088;
    }

    # HTTP to HTTPS redirect - PF domains
    server {
        listen 80;
        server_name n3xuscos.online www.n3xuscos.online beta.n3xuscos.online;
        return 301 https://$server_name$request_uri;
    }

    # Main HTTPS server for n3xuscos.online
    server {
        listen 443 ssl http2;
        server_name n3xuscos.online www.n3xuscos.online;

        # IONOS SSL Configuration
        ssl_certificate /etc/ssl/ionos/fullchain.pem;
        ssl_certificate_key /etc/ssl/ionos/privkey.pem;
        ssl_trusted_certificate /etc/ssl/ionos/chain.pem;

        # SSL Security Settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # Domain-specific logging
        access_log /var/log/nginx/n3xuscos.online_access.log;
        error_log /var/log/nginx/n3xuscos.online_error.log;

        # Enable upstream error interception for fallback
        proxy_intercept_errors on;
        
        # Redirect upstream errors to fallback page
        error_page 500 502 503 504 = /pf-fallback;

        # PF Gateway Health Check
        location /health {
            proxy_pass http://pf_gateway/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # HOLOFABRIC Spatial Runtime - Internal Runtime Gateway
        location /holofabric/runtime {
            proxy_pass http://holofabric_runtime/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF Service Health Checks
        location /health/puaboai-sdk {
            proxy_pass http://pf_puaboai_sdk/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /health/pv-keys {
            proxy_pass http://pf_pv_keys/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # PF Frontend Routes - Admin Panel
        location /admin {
            proxy_pass http://pf_gateway/admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF Frontend Routes - Creator Hub
        location /hub {
            proxy_pass http://pf_gateway/hub;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF Frontend Routes - Studio
        location /studio {
            proxy_pass http://pf_gateway/studio;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF Frontend Routes - Streaming
        # Proxy to pf_gateway for containerized deployment
        location /streaming {
            proxy_pass http://pf_gateway/streaming;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF Frontend Routes - Casino
        # Proxy to pf_gateway for containerized deployment
        location /casino {
            proxy_pass http://pf_gateway/casino;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Platform Launcher - Unified module/service tiles
        location /platform {
            return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus COS Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            color: #fff;
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle { color: #a0a0b0; margin-bottom: 3rem; font-size: 1.2rem; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .tile {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }
        .tile:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .tile:active {
            transform: translateY(-2px);
        }
        .tile h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        .tile p { color: #a0a0b0; line-height: 1.6; }
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 1rem;
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Nexus COS Platform</h1>
        <p class="subtitle">Select a module to launch</p>
        <div class="grid">
            <a href="/streaming" class="tile">
                <h3>üì∫ Streaming</h3>
                <p>Netflix-style streaming interface with live content delivery</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/casino" class="tile">
                <h3>üé∞ Casino Nexus</h3>
                <p>Virtual crypto-integrated casino with V5 3D engine</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/v-suite/hollywood" class="tile">
                <h3>üé¨ V-Screen Hollywood</h3>
                <p>Virtual LED volume and production suite</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/v-suite/stage" class="tile">
                <h3>üé≠ V-Stage</h3>
                <p>Stage management and performance tools</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/v-suite/caster" class="tile">
                <h3>üì° V-Caster Pro</h3>
                <p>Professional streaming and broadcasting</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/v-suite/prompter" class="tile">
                <h3>üìù V-Prompter Pro</h3>
                <p>AI-powered teleprompter and content generation</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/api" class="tile">
                <h3>üîå API Gateway</h3>
                <p>RESTful API access and documentation</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/admin" class="tile">
                <h3>‚öôÔ∏è Admin Panel</h3>
                <p>Platform administration and configuration</p>
                <span class="status">‚óè Active</span>
            </a>
            <a href="/hub" class="tile">
                <h3>üé® Creator Hub</h3>
                <p>Content creation and management tools</p>
                <span class="status">‚óè Active</span>
            </a>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # PF Fallback - Intelligent upstream error handler
        location /pf-fallback {
            return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus COS - Service Temporarily Unavailable</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .container {
            text-align: center;
            max-width: 600px;
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        p { color: #a0a0b0; margin-bottom: 2rem; font-size: 1.1rem; line-height: 1.6; }
        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö†Ô∏è Service Temporarily Unavailable</h1>
        <p>The requested service is currently unavailable. Our platform launcher is still accessible with all other modules.</p>
        <a href="/platform" class="btn">Return to Platform Launcher</a>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # Brand Check - Branding validation page
        location /brand-check {
            return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus COS - Brand Check</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            color: #fff;
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .section { margin-bottom: 3rem; }
        .section h2 { color: #667eea; margin-bottom: 1rem; }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .color-box {
            height: 100px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dark-bg { background: #1a1a2e; }
        .darker-bg { background: #0f0f23; }
        .accent { background: #667eea; }
        .text-muted { background: #a0a0b0; color: #1a1a2e; }
        .interactive-demo button {
            padding: 1rem 2rem;
            margin: 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .interactive-demo button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .interactive-demo button:active { transform: translateY(0); }
        .status { color: #4caf50; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Nexus COS Brand Check</h1>
        
        <div class="section">
            <h2>Color Palette</h2>
            <div class="color-grid">
                <div class="color-box primary">Primary Gradient</div>
                <div class="color-box accent">Accent Blue</div>
                <div class="color-box dark-bg">Dark Background</div>
                <div class="color-box darker-bg">Darker Background</div>
                <div class="color-box text-muted">Text Muted</div>
            </div>
        </div>

        <div class="section">
            <h2>Interactivity Test</h2>
            <div class="interactive-demo">
                <button onclick="alert(\'Nexus COS - Interactive Element Working!\')">Test Button Interaction</button>
                <button onclick="window.location.href=\'/platform\'">Navigate to Platform</button>
            </div>
        </div>

        <div class="section">
            <h2>Branding Status</h2>
            <p class="status">‚úì Blue gradient theme active</p>
            <p class="status">‚úì Dark mode consistent</p>
            <p class="status">‚úì Hover states working</p>
            <p class="status">‚úì Interactive elements responsive</p>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # PF API Gateway
        location /api {
            proxy_pass http://pf_gateway/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF V-Suite Routes - Hollywood (V-Screen Hollywood Edition)
        location /v-suite/hollywood {
            proxy_pass http://vscreen_hollywood/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF V-Suite Routes - Prompter (v-prompter-pro)
        location /v-suite/prompter {
            proxy_pass http://pf_puaboai_sdk/v-suite/prompter;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF V-Suite Routes - Caster
        location /v-suite/caster {
            # Feature Flag: OTT Streaming
            if (!-f /etc/nginx/flags/ott_enabled) {
                return 404;
            }
            proxy_pass http://pf_gateway/v-suite/caster;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF V-Suite Routes - Stage
        location /v-suite/stage {
            # Feature Flag: OTT Streaming
            if (!-f /etc/nginx/flags/ott_enabled) {
                return 404;
            }
            proxy_pass http://pf_gateway/v-suite/stage;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # PF V-Screen Route
        location /v-screen {
            # Feature Flag: OTT Streaming
            if (!-f /etc/nginx/flags/ott_enabled) {
                return 404;
            }
            proxy_pass http://pf_gateway/v-screen;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # SPA Routes - Apex
        location /apex/ {
            alias /usr/share/nginx/html/apex/;
            index index.html;
            try_files $uri $uri/ /apex/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # SPA Routes - Beta Landing
        location /beta/ {
            alias /usr/share/nginx/html/beta/;
            index index.html;
            try_files $uri $uri/ /beta/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # SPA Routes - Drops
        location /drops/ {
            alias /usr/share/nginx/html/drops/;
            index index.html;
            try_files $uri $uri/ /drops/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # SPA Routes - Docs
        location /docs/ {
            alias /usr/share/nginx/html/docs/;
            index index.html;
            try_files $uri $uri/ /docs/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # Hashed assets
        location /assets/ {
            alias /usr/share/nginx/html/assets/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Root - Main gateway entrypoint (fallback to pf_gateway)
        location = / {
            proxy_pass http://pf_gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Root - Main Frontend (fallback for other paths)
        location / {
            proxy_pass http://pf_gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Monitoring subdomain
    server {
        listen 443 ssl http2;
        server_name monitoring.n3xuscos.online;

        # IONOS SSL Configuration
        ssl_certificate /etc/ssl/ionos/fullchain.pem;
        ssl_certificate_key /etc/ssl/ionos/privkey.pem;
        ssl_trusted_certificate /etc/ssl/ionos/chain.pem;

        # SSL Security Settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # Domain-specific logging
        access_log /var/log/nginx/monitoring.n3xuscos.online_access.log;
        error_log /var/log/nginx/monitoring.n3xuscos.online_error.log;

        # Monitoring (Grafana)
        location / {
            proxy_pass http://localhost:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Beta subdomain - beta.n3xuscos.online
    server {
        listen 443 ssl http2;
        server_name beta.n3xuscos.online;

        # IONOS SSL Configuration for beta
        ssl_certificate /etc/ssl/ionos/beta.n3xuscos.online/fullchain.pem;
        ssl_certificate_key /etc/ssl/ionos/beta.n3xuscos.online/privkey.pem;

        # SSL Security Settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Environment "beta" always;

        # Domain-specific logging
        access_log /var/log/nginx/beta.n3xuscos.online_access.log;
        error_log /var/log/nginx/beta.n3xuscos.online_error.log;

        # Beta Health Check
        location /health {
            proxy_pass http://pf_gateway/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Beta API Gateway
        location /api {
            proxy_pass http://pf_gateway/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Beta Streaming via PF gateway
        location /streaming {
            proxy_pass http://pf_gateway/streaming;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Casino V5 Frontend
        location /casino {
            proxy_pass http://pf_gateway/casino;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Beta VR modules via PF gateway
        location /v-screen {
            proxy_pass http://pf_gateway/v-screen;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /v-suite/stage {
            proxy_pass http://pf_gateway/v-suite/stage;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /v-suite/caster {
            proxy_pass http://pf_gateway/v-suite/caster;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /v-suite/hollywood {
            proxy_pass http://pf_gateway/v-suite/hollywood;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Beta SPA Routes
        location /apex/ {
            alias /usr/share/nginx/html/apex/;
            index index.html;
            try_files $uri $uri/ /apex/index.html;
        }

        location /beta/ {
            alias /usr/share/nginx/html/beta/;
            index index.html;
            try_files $uri $uri/ /beta/index.html;
        }

        location /drops/ {
            alias /usr/share/nginx/html/drops/;
            index index.html;
            try_files $uri $uri/ /drops/index.html;
        }

        location /docs/ {
            alias /usr/share/nginx/html/docs/;
            index index.html;
            try_files $uri $uri/ /docs/index.html;
        }

        location /assets/ {
            alias /usr/share/nginx/html/assets/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Beta root - redirect to streaming
        location = / {
            return 301 /streaming;
        }

        # Beta Frontend (fallback)
        location / {
            proxy_pass http://pf_gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
