# Apache2 VHost Configuration for Nexus COS Socket.IO Streaming
# File: /var/www/vhosts/system/nexuscos.online/conf/vhost.conf
#
# Installation Instructions:
# 1. Enable required Apache2 modules:
#    a2enmod proxy proxy_http proxy_wstunnel
#
# 2. Add this configuration to your vhost.conf file
#
# 3. Test configuration:
#    apachectl configtest
#
# 4. Reload Apache2:
#    systemctl reload apache2
#
# 5. Verify Socket.IO endpoints:
#    curl -sS https://nexuscos.online/socket.io/?EIO=4&transport=polling
#    curl -sS https://nexuscos.online/streaming/socket.io/?EIO=4&transport=polling

# Socket.IO Streaming Service - Main Path
# Handles WebSocket connections at /streaming/socket.io/
<Location /streaming/socket.io/>
    ProxyPass http://127.0.0.1:3043/socket.io/
    ProxyPassReverse http://127.0.0.1:3043/socket.io/
    
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /streaming/socket.io/(.*) ws://127.0.0.1:3043/socket.io/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /streaming/socket.io/(.*) http://127.0.0.1:3043/socket.io/$1 [P,L]
    
    # Headers for WebSocket
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
</Location>

# Socket.IO Streaming Service - Root Path
# Handles WebSocket connections at /socket.io/
<Location /socket.io/>
    ProxyPass http://127.0.0.1:3043/socket.io/ retry=0
    ProxyPassReverse http://127.0.0.1:3043/socket.io/
    
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /socket.io/(.*) ws://127.0.0.1:3043/socket.io/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /socket.io/(.*) http://127.0.0.1:3043/socket.io/$1 [P,L]
    
    # Headers for WebSocket
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
</Location>

# Streaming Service Health Check
<Location /streaming/health>
    ProxyPass http://127.0.0.1:3043/streaming/health
    ProxyPassReverse http://127.0.0.1:3043/streaming/health
</Location>

# Optional: Streaming page/UI (if you have static content)
<Location /streaming>
    ProxyPass http://127.0.0.1:3043/streaming
    ProxyPassReverse http://127.0.0.1:3043/streaming
</Location>
