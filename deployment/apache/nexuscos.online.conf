# ==============================================================================
# Nexus COS Apache Configuration for Plesk
# Domain: nexuscos.online
# Purpose: Proxy configuration for WebSocket and Socket.IO support
# ==============================================================================
#
# Usage with Plesk:
# 1. Go to Domains > nexuscos.online > Apache & nginx Settings
# 2. Enable "Additional Apache directives" 
# 3. Paste the content below into the "Additional directives for HTTPS" section
# 4. Apply changes and restart Apache
#
# ==============================================================================

# Enable required modules (ensure these are enabled in Plesk)
# a2enmod proxy proxy_http proxy_wstunnel rewrite headers

# ==============================================================================
# Proxy Configuration for API and Services
# ==============================================================================

# Main API endpoint
ProxyPass /api/ http://127.0.0.1:3001/ retry=0
ProxyPassReverse /api/ http://127.0.0.1:3001/

# Health endpoint
ProxyPass /health http://127.0.0.1:3001/health retry=0
ProxyPassReverse /health http://127.0.0.1:3001/health

# API Health endpoint
ProxyPass /api/health http://127.0.0.1:4000/health retry=0
ProxyPassReverse /api/health http://127.0.0.1:4000/health

# ==============================================================================
# Socket.IO and WebSocket Configuration
# ==============================================================================

# Root Socket.IO endpoint (WebSocket upgrade)
RewriteEngine On
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteRule /socket.io/(.*) ws://127.0.0.1:3001/socket.io/$1 [P,L]
RewriteCond %{HTTP:Upgrade} !=websocket [NC]
RewriteRule /socket.io/(.*) http://127.0.0.1:3001/socket.io/$1 [P,L]

ProxyPass /socket.io/ http://127.0.0.1:3001/socket.io/ retry=0
ProxyPassReverse /socket.io/ http://127.0.0.1:3001/socket.io/

# Streaming Socket.IO endpoint (WebSocket upgrade)
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteRule /streaming/socket.io/(.*) ws://127.0.0.1:3001/socket.io/$1 [P,L]
RewriteCond %{HTTP:Upgrade} !=websocket [NC]
RewriteRule /streaming/socket.io/(.*) http://127.0.0.1:3001/socket.io/$1 [P,L]

ProxyPass /streaming/socket.io/ http://127.0.0.1:3001/socket.io/ retry=0
ProxyPassReverse /streaming/socket.io/ http://127.0.0.1:3001/socket.io/

# ==============================================================================
# Streaming Service
# ==============================================================================

ProxyPass /streaming/ http://127.0.0.1:3001/streaming/ retry=0
ProxyPassReverse /streaming/ http://127.0.0.1:3001/streaming/

# ==============================================================================
# Creator Hub Service
# ==============================================================================

ProxyPass /creator/ http://127.0.0.1:3020/ retry=0
ProxyPassReverse /creator/ http://127.0.0.1:3020/

ProxyPass /creator-hub/ http://127.0.0.1:3020/ retry=0
ProxyPassReverse /creator-hub/ http://127.0.0.1:3020/

# ==============================================================================
# V-Suite Services
# ==============================================================================

ProxyPass /v-suite/ http://127.0.0.1:3010/ retry=0
ProxyPassReverse /v-suite/ http://127.0.0.1:3010/

# ==============================================================================
# AI Service
# ==============================================================================

ProxyPass /ai/ http://127.0.0.1:3010/ retry=0
ProxyPassReverse /ai/ http://127.0.0.1:3010/

# ==============================================================================
# Keys Service
# ==============================================================================

ProxyPass /keys/ http://127.0.0.1:3014/ retry=0
ProxyPassReverse /keys/ http://127.0.0.1:3014/

# ==============================================================================
# PuaboVerse Module
# ==============================================================================

ProxyPass /puaboverse/ http://127.0.0.1:3030/ retry=0
ProxyPassReverse /puaboverse/ http://127.0.0.1:3030/

# ==============================================================================
# PUABO NEXUS Fleet Services
# ==============================================================================

# Gateway
ProxyPass /health/gateway http://127.0.0.1:4000/health retry=0
ProxyPassReverse /health/gateway http://127.0.0.1:4000/health

# AI Dispatch Service
ProxyPass /puabo-nexus/dispatch http://127.0.0.1:9001 retry=0
ProxyPassReverse /puabo-nexus/dispatch http://127.0.0.1:9001

# Driver Backend Service
ProxyPass /puabo-nexus/driver http://127.0.0.1:9002 retry=0
ProxyPassReverse /puabo-nexus/driver http://127.0.0.1:9002

# Fleet Manager Service
ProxyPass /puabo-nexus/fleet http://127.0.0.1:9003 retry=0
ProxyPassReverse /puabo-nexus/fleet http://127.0.0.1:9003

# Route Optimizer Service
ProxyPass /puabo-nexus/routes http://127.0.0.1:9004 retry=0
ProxyPassReverse /puabo-nexus/routes http://127.0.0.1:9004

# ==============================================================================
# WebSocket Settings
# ==============================================================================

# Increase timeout for WebSocket connections
ProxyTimeout 86400

# Enable WebSocket proxy
<IfModule mod_proxy_wstunnel.c>
    ProxyPreserveHost On
</IfModule>

# ==============================================================================
# Security Headers
# ==============================================================================

Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "no-referrer-when-downgrade"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
