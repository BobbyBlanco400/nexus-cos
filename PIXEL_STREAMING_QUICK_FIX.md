# Pixel Streaming Signalling - Quick Fix Guide

## The Problem

When running the manual Apache configuration command from the problem statement, you get:

```
AH00526: Syntax error on line 11 of /var/www/vhosts/system/nexuscos.online/conf/vhost_ssl.conf:
ProxyRequests must be On or Off
```

## The Root Cause

The Apache configuration generated by the manual command is **missing the `ProxyRequests Off` directive**. 

When using `ProxyPass`, Apache requires an explicit `ProxyRequests` setting to prevent the server from being used as an open forward proxy (a security risk).

## The Fix

### Quick One-Liner Fix (Automated)

```bash
cd /opt/nexus-cos
./scripts/deploy-pixel-signalling.sh nexuscos.online 8888
```

This script:
- ✅ Deploys the signalling server container correctly
- ✅ Generates Apache config with `ProxyRequests Off`
- ✅ Enables required Apache modules
- ✅ Validates the configuration
- ✅ Tests all endpoints

### Manual Fix (If You Need Custom Setup)

1. **Add `ProxyRequests Off` to your Apache configuration:**

```apache
<IfModule mod_proxy.c>
  # THIS LINE IS CRITICAL - IT WAS MISSING!
  ProxyRequests Off
  
  <Location /v-suite/hollywood>
    ProxyPass http://127.0.0.1:8888/
    ProxyPassReverse http://127.0.0.1:8888/
  </Location>
</IfModule>
```

2. **Validate and reload:**

```bash
apache2ctl -t
systemctl reload apache2
```

## What Changed

### Before (Broken):
```apache
<IfModule mod_proxy.c>
  <Location /v-suite/hollywood>
    ProxyPass http://127.0.0.1:8888/
    ProxyPassReverse http://127.0.0.1:8888/
  </Location>
</IfModule>
```
**Problem**: Missing `ProxyRequests Off` → Apache syntax error

### After (Fixed):
```apache
<IfModule mod_proxy.c>
  ProxyRequests Off  ← THIS LINE FIXES IT
  ProxyPreserveHost On
  
  <Location /v-suite/hollywood>
    ProxyPass http://127.0.0.1:8888/
    ProxyPassReverse http://127.0.0.1:8888/
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
  </Location>
</IfModule>
```
**Fixed**: Includes `ProxyRequests Off` + security headers

## Why `ProxyRequests Off` is Required

Apache's `ProxyPass` directive creates a **reverse proxy** (client → Apache → backend).

Without `ProxyRequests Off`, Apache thinks you want a **forward proxy** (client → Apache → anywhere), which:
- Is a security risk (open proxy)
- Requires explicit On/Off setting
- Causes the syntax error when not specified

## Additional Improvements in the Fix

The automated script also adds:

1. **WebSocket Support** (for pixel streaming):
```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/v-suite/hollywood/(.*)$ ws://127.0.0.1:8888/$1 [P,L]
</IfModule>
```

2. **Security Headers**:
```apache
RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Forwarded-Port "443"
```

3. **Proper Module Enablement**:
```bash
a2enmod proxy proxy_http proxy_wstunnel rewrite headers
```

## Verification

After applying the fix, verify it works:

```bash
# Check Apache syntax
apache2ctl -t
# Should show: Syntax OK

# Test endpoints
curl -I https://nexuscos.online/v-suite/hollywood/

# Check container
docker ps | grep nexus-pixel-signalling
```

## Files Created

1. **`config/apache-pixel-signalling.conf.template`** - Apache config template
2. **`scripts/deploy-pixel-signalling.sh`** - Automated deployment script
3. **`PIXEL_STREAMING_DEPLOYMENT.md`** - Comprehensive documentation
4. **`PIXEL_STREAMING_QUICK_FIX.md`** - This file

## Need Help?

See the full documentation: `PIXEL_STREAMING_DEPLOYMENT.md`

---

**TL;DR**: Add `ProxyRequests Off` to your Apache proxy configuration, or use the automated script.
