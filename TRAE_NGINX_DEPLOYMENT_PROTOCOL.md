# TRAE DEPLOYMENT GUIDE - NGINX FIX
## 100% Completion - Zero Deviations - Full VPS Deployment

---

## EXECUTIVE SUMMARY FOR TRAE

**WHAT WAS FIXED:**
1. ✅ Duplicate server_name entries on port 80 (nginx warnings eliminated)
2. ✅ Backticks in CSP and Location headers (complete removal)
3. ✅ Redirect patterns normalized (`$server_name` → `$host`)
4. ✅ Duplicate CSP headers removed from vhosts (single source of truth)
5. ✅ Duplicate gateway configs eliminated

**FILES MODIFIED:**
- `scripts/pf-fix-nginx-headers-redirect.sh` (enhanced)
- `scripts/vps-nginx-fix-one-liner.sh` (NEW - VPS deployment)
- 9 deployment nginx configs (redirect patterns fixed)
- `NGINX_FIX_README.md` (documentation)
- `NGINX_FIX_QUICK_START.md` (quick reference)
- `test-nginx-fix.sh` (validation suite)

---

## TRAE EXECUTION PROTOCOL - STEP BY STEP
### Follow Each Step EXACTLY - No Deviations - 100% Completion Required

---

### PHASE 1: PRE-DEPLOYMENT VERIFICATION
**Duration: 2 minutes**

#### STEP 1.1: Verify Repository Files
```bash
cd /home/runner/work/nexus-cos/nexus-cos
ls -la scripts/pf-fix-nginx-headers-redirect.sh
ls -la scripts/vps-nginx-fix-one-liner.sh
ls -la NGINX_FIX_README.md
```

**EXPECTED OUTPUT:**
```
-rwxr-xr-x scripts/pf-fix-nginx-headers-redirect.sh
-rwxr-xr-x scripts/vps-nginx-fix-one-liner.sh
-rw-r--r-- NGINX_FIX_README.md
```

**VALIDATION:** All three files must exist and scripts must be executable.

---

#### STEP 1.2: Run Test Suite
```bash
cd /home/runner/work/nexus-cos/nexus-cos
bash test-nginx-fix.sh
```

**EXPECTED OUTPUT:**
```
================================================================================
All Tests Passed! ✓
================================================================================
```

**VALIDATION:** All 9 tests must pass. If any test fails, STOP and report issue.

---

### PHASE 2: VPS SERVER PREPARATION
**Duration: 3 minutes**

#### STEP 2.1: SSH to VPS Server
```bash
ssh root@YOUR_VPS_IP
# OR
ssh -i /path/to/key root@YOUR_VPS_IP
```

**VALIDATION:** You must have root access. Verify with:
```bash
whoami
# OUTPUT: root
```

---

#### STEP 2.2: Backup Current Nginx Configuration
```bash
# Create backup directory
mkdir -p /root/nginx-backup-$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="/root/nginx-backup-$(date +%Y%m%d-%H%M%S)"

# Backup nginx configs
cp -r /etc/nginx "$BACKUP_DIR/"
if [ -d /var/www/vhosts/system ]; then
    cp -r /var/www/vhosts/system "$BACKUP_DIR/"
fi

# Verify backup
ls -la "$BACKUP_DIR/"
echo "Backup saved to: $BACKUP_DIR"
```

**VALIDATION:** Backup directory must contain nginx folder.

---

#### STEP 2.3: Verify Nginx is Running
```bash
systemctl status nginx
nginx -v
```

**EXPECTED OUTPUT:**
```
Active: active (running)
nginx version: nginx/1.x.x
```

**VALIDATION:** Nginx must be running. If not, start it:
```bash
systemctl start nginx
```

---

### PHASE 3: DEPLOY NGINX FIX TO VPS
**Duration: 5 minutes**

#### STEP 3.1: Execute VPS One-Liner Fix
**COPY AND PASTE THIS ENTIRE COMMAND AS ONE BLOCK:**

```bash
sudo bash -c 'set -e
DOMAIN=nexuscos.online

# Write clean security headers (single source of truth)
cat >/etc/nginx/conf.d/zz-security-headers.conf <<'\''EOF'\''
# Nexus COS Security Headers
# Generated by VPS Nginx Fix One-Liner

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy
add_header Content-Security-Policy "default-src '\''self'\'' https://nexuscos.online; img-src '\''self'\'' data: blob: https://nexuscos.online; script-src '\''self'\'' '\''unsafe-inline'\'' https://nexuscos.online; style-src '\''self'\'' '\''unsafe-inline'\'' https://nexuscos.online; connect-src '\''self'\'' https://nexuscos.online https://nexuscos.online/streaming wss://nexuscos.online ws://nexuscos.online;" always;

# X-Content-Type-Options
add_header X-Content-Type-Options "nosniff" always;

# X-Frame-Options
add_header X-Frame-Options "SAMEORIGIN" always;

# Referrer-Policy
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# X-XSS-Protection (Legacy)
add_header X-XSS-Protection "1; mode=block" always;
EOF

# Ensure nginx.conf includes conf.d/*.conf
grep -q "conf.d/.*\.conf" /etc/nginx/nginx.conf || sed -i "/^http[[:space:]]*{/a \    include /etc/nginx/conf.d/*.conf;" /etc/nginx/nginx.conf

# Fix redirect in all vhosts and strip backticks + duplicate CSP lines
for ROOT in /etc/nginx /var/www/vhosts/system; do
  [ -d "$ROOT" ] || continue
  
  # Normalize redirect patterns for apex+www
  for VF in $(grep -RIl --include="*.conf" -E "server_name.*($DOMAIN|www\.$DOMAIN)" "$ROOT" 2>/dev/null || true); do
    # Fix redirect patterns
    sed -i "s|return[[:space:]]*301[[:space:]]*https://\$server_name\$request_uri;|return 301 https://\$host\$request_uri;|g" "$VF"
    sed -i "s|return[[:space:]]*301[[:space:]]*https://[a-zA-Z0-9.-]*\$request_uri;|return 301 https://\$host\$request_uri;|g" "$VF"
    sed -i "s|return[[:space:]]*301[[:space:]]*https://;|return 301 https://\$host\$request_uri;|g" "$VF"
    
    # Remove any CSP add_header from vhosts so only zz-security-headers.conf applies
    sed -i "/add_header[[:space:]]\+Content-Security-Policy/d" "$VF"
  done
  
  # Strip any stray backticks from all confs
  if command -v perl &> /dev/null; then
    find "$ROOT" -type f -name "*.conf" -print0 2>/dev/null | xargs -0 perl -0777 -pe "s/\x60//g" -i 2>/dev/null || true
  else
    find "$ROOT" -type f -name "*.conf" -exec sed -i "s/\`//g" {} \; 2>/dev/null || true
  fi
done

# If Plesk vhost exists, remove our redirect file to avoid duplicate server_name warnings
if ls /var/www/vhosts/system/"$DOMAIN"/conf/vhost_nginx.conf >/dev/null 2>&1 || \
   ls /var/www/vhosts/system/"$DOMAIN"/conf/nginx.conf >/dev/null 2>&1; then
  rm -f /etc/nginx/conf.d/zz-redirect.conf
fi

# Remove known duplicate gateway confs
rm -f /etc/nginx/conf.d/pf_gateway_${DOMAIN}.conf /etc/nginx/conf.d/pf_gateway_www.${DOMAIN}.conf

# Validate and reload
nginx -t && systemctl reload nginx

# Verify
echo ""
echo "=============================================================================="
echo "VERIFICATION OUTPUT"
echo "=============================================================================="
echo ""
echo "--- HTTPS HEADERS ---"
curl -fsSI "https://$DOMAIN/" 2>/dev/null | tr -d "\r" | egrep -i "^(Strict-Transport-Security|Content-Security-Policy|X-Content-Type-Options|X-Frame-Options|Referrer-Policy):" || echo "Could not fetch HTTPS headers (this is normal if testing locally)"

echo ""
echo "--- HTTP REDIRECT ---"
curl -fsSI "http://$DOMAIN/" 2>/dev/null | tr -d "\r" | egrep -i "^(HTTP|Location):" || echo "Could not fetch HTTP redirect (this is normal if testing locally)"

echo ""
echo "=============================================================================="
echo "DEPLOYMENT COMPLETE"
echo "=============================================================================="
echo "✓ Security headers configured in /etc/nginx/conf.d/zz-security-headers.conf"
echo "✓ Redirect patterns normalized to https://\$host\$request_uri"
echo "✓ Duplicate CSP headers removed from vhosts"
echo "✓ Backticks stripped from all configs"
echo "✓ Duplicate configs removed"
echo "✓ Nginx validated and reloaded"
echo ""
'
```

**VALIDATION CHECKPOINTS:**
1. Command executes without errors
2. `nginx -t` shows "syntax is ok"
3. `systemctl reload nginx` succeeds
4. Verification output shows headers WITHOUT backticks

---

#### STEP 3.2: Verify Security Headers Configuration File Created
```bash
cat /etc/nginx/conf.d/zz-security-headers.conf
```

**EXPECTED OUTPUT:**
```
# Nexus COS Security Headers
# Generated by VPS Nginx Fix One-Liner

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy
add_header Content-Security-Policy "default-src 'self' https://nexuscos.online; img-src 'self' data: blob: https://nexuscos.online; script-src 'self' 'unsafe-inline' https://nexuscos.online; style-src 'self' 'unsafe-inline' https://nexuscos.online; connect-src 'self' https://nexuscos.online https://nexuscos.online/streaming wss://nexuscos.online ws://nexuscos.online;" always;

# X-Content-Type-Options
add_header X-Content-Type-Options "nosniff" always;

# X-Frame-Options
add_header X-Frame-Options "SAMEORIGIN" always;

# Referrer-Policy
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# X-XSS-Protection (Legacy)
add_header X-XSS-Protection "1; mode=block" always;
```

**VALIDATION:** File must exist with NO backticks (``).

---

#### STEP 3.3: Verify Redirect Patterns Fixed
```bash
grep -r "return.*301.*https" /etc/nginx/ 2>/dev/null | grep -v "\$host"
```

**EXPECTED OUTPUT:** (Should be empty - no output)

**VALIDATION:** If any lines appear, redirect patterns are NOT using `$host`. STOP and report.

---

#### STEP 3.4: Verify No Backticks in Any Config
```bash
grep -r '`' /etc/nginx/ /var/www/vhosts/system/ 2>/dev/null | grep -v ".backup"
```

**EXPECTED OUTPUT:** (Should be empty - no output)

**VALIDATION:** If any lines appear containing backticks, STOP and report.

---

#### STEP 3.5: Verify Duplicate Configs Removed
```bash
ls -la /etc/nginx/conf.d/ | grep -E "zz-redirect|pf_gateway"
```

**EXPECTED OUTPUT:** (Should be empty - no output)

**VALIDATION:** These duplicate files should NOT exist.

---

### PHASE 4: POST-DEPLOYMENT VERIFICATION
**Duration: 3 minutes**

#### STEP 4.1: Test HTTPS Headers
```bash
curl -I https://nexuscos.online/ 2>/dev/null | tr -d '\r'
```

**EXPECTED OUTPUT MUST INCLUDE:**
```
HTTP/2 200
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Content-Security-Policy: default-src 'self' https://nexuscos.online; img-src 'self' data: blob: https://nexuscos.online; script-src 'self' 'unsafe-inline' https://nexuscos.online; style-src 'self' 'unsafe-inline' https://nexuscos.online; connect-src 'self' https://nexuscos.online https://nexuscos.online/streaming wss://nexuscos.online ws://nexuscos.online;
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Referrer-Policy: no-referrer-when-downgrade
```

**VALIDATION:** 
- ❌ NO backticks (`) anywhere in headers
- ✅ All security headers present
- ✅ CSP header shows proper quoted values ('self', 'unsafe-inline')

---

#### STEP 4.2: Test HTTP Redirect
```bash
curl -I http://nexuscos.online/ 2>/dev/null | tr -d '\r'
```

**EXPECTED OUTPUT:**
```
HTTP/1.1 301 Moved Permanently
Server: nginx
Location: https://nexuscos.online/
```

**VALIDATION:**
- ❌ NO backticks (`) in Location header
- ✅ Location header uses https://
- ✅ Status is 301 Moved Permanently

---

#### STEP 4.3: Test WWW Redirect
```bash
curl -I http://www.nexuscos.online/ 2>/dev/null | tr -d '\r'
```

**EXPECTED OUTPUT:**
```
HTTP/1.1 301 Moved Permanently
Server: nginx
Location: https://www.nexuscos.online/
```

**VALIDATION:** WWW subdomain redirects correctly without backticks.

---

#### STEP 4.4: Verify No Nginx Warnings
```bash
nginx -t
```

**EXPECTED OUTPUT:**
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

**VALIDATION:** 
- ❌ NO warnings about duplicate server_name
- ✅ Syntax is ok
- ✅ Test is successful

---

#### STEP 4.5: Verify Nginx Service Status
```bash
systemctl status nginx
```

**EXPECTED OUTPUT:**
```
● nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded
   Active: active (running)
```

**VALIDATION:** Nginx must be active and running.

---

### PHASE 5: NEXUS COS PLATFORM STACK INTEGRATION
**Duration: 5 minutes**

#### STEP 5.1: Verify Platform Stack Services
```bash
# Check all Nexus COS services
systemctl status nginx
pm2 status
docker ps
```

**EXPECTED OUTPUT:**
- Nginx: active (running)
- PM2: List of running processes
- Docker: Running containers (if applicable)

**VALIDATION:** All critical services running.

---

#### STEP 5.2: Test API Endpoints
```bash
# Test main API endpoint
curl -I https://nexuscos.online/api/health 2>/dev/null

# Test streaming endpoint
curl -I https://nexuscos.online/streaming/ 2>/dev/null
```

**VALIDATION:** Endpoints should return 200 or expected status codes.

---

#### STEP 5.3: Test WebSocket Connections
```bash
# Verify WSS is working (check headers allow upgrades)
curl -I https://nexuscos.online/ 2>/dev/null | grep -i upgrade
```

**VALIDATION:** Nginx should allow WebSocket upgrades.

---

### PHASE 6: GLOBAL LAUNCH VERIFICATION
**Duration: 5 minutes**

#### STEP 6.1: Test from Multiple Locations
```bash
# Test apex domain
curl -I https://nexuscos.online/ 2>/dev/null | head -20

# Test www subdomain
curl -I https://www.nexuscos.online/ 2>/dev/null | head -20

# Test monitoring subdomain (if configured)
curl -I https://monitoring.nexuscos.online/ 2>/dev/null | head -20
```

**VALIDATION:** All subdomains respond correctly with security headers.

---

#### STEP 6.2: SSL/TLS Certificate Verification
```bash
echo | openssl s_client -connect nexuscos.online:443 -servername nexuscos.online 2>/dev/null | openssl x509 -noout -dates -subject
```

**EXPECTED OUTPUT:**
```
notBefore=...
notAfter=...
subject=CN=nexuscos.online
```

**VALIDATION:** Certificate is valid and not expired.

---

#### STEP 6.3: Security Headers Verification (External Check)
```bash
# Check security headers are visible externally
curl -I -k https://nexuscos.online/ 2>/dev/null | grep -E "Strict-Transport|Content-Security|X-Frame|X-Content-Type|Referrer-Policy"
```

**VALIDATION:** All 5 security headers must be present.

---

#### STEP 6.4: Performance Check
```bash
# Check response time
time curl -I https://nexuscos.online/ 2>/dev/null
```

**VALIDATION:** Response time should be reasonable (< 3 seconds).

---

### PHASE 7: DOCUMENTATION AND HANDOFF
**Duration: 2 minutes**

#### STEP 7.1: Generate Deployment Report
```bash
cat > /root/nginx-fix-deployment-report.txt <<'EOF'
NEXUS COS - NGINX FIX DEPLOYMENT REPORT
========================================
Deployment Date: $(date)
Executed by: $(whoami)

FIXES APPLIED:
✓ Duplicate server_name entries removed
✓ Backticks stripped from all configs
✓ Redirect patterns normalized to $host
✓ Duplicate CSP headers removed
✓ Duplicate gateway configs removed
✓ Single source of truth for security headers

FILES MODIFIED:
- /etc/nginx/conf.d/zz-security-headers.conf (CREATED)
- All vhost configs in /etc/nginx and /var/www/vhosts/system (UPDATED)
- Removed: zz-redirect.conf, pf_gateway_*.conf

VALIDATION RESULTS:
$(nginx -t 2>&1)

SECURITY HEADERS:
$(curl -I https://nexuscos.online/ 2>/dev/null | grep -E "Strict-Transport|Content-Security|X-Frame|X-Content-Type|Referrer-Policy")

HTTP REDIRECT:
$(curl -I http://nexuscos.online/ 2>/dev/null | grep -E "HTTP|Location")

BACKUP LOCATION:
$BACKUP_DIR

STATUS: DEPLOYMENT COMPLETE ✓
========================================
EOF

cat /root/nginx-fix-deployment-report.txt
```

**VALIDATION:** Report file created and contains all verification data.

---

#### STEP 7.2: Save Deployment Artifacts
```bash
# Create deployment package
mkdir -p /root/nginx-fix-deployment-artifacts
cp /etc/nginx/conf.d/zz-security-headers.conf /root/nginx-fix-deployment-artifacts/
cp /root/nginx-fix-deployment-report.txt /root/nginx-fix-deployment-artifacts/
echo "Artifacts saved to: /root/nginx-fix-deployment-artifacts"
ls -la /root/nginx-fix-deployment-artifacts/
```

**VALIDATION:** Artifacts directory contains deployment files.

---

### PHASE 8: FINAL CHECKLIST - 100% COMPLETION VERIFICATION

**TRAE MUST VERIFY EACH ITEM:**

- [ ] **STEP 1:** Repository files verified ✓
- [ ] **STEP 2:** Test suite passed (9/9 tests) ✓
- [ ] **STEP 3:** SSH access to VPS confirmed ✓
- [ ] **STEP 4:** Nginx backup created ✓
- [ ] **STEP 5:** VPS one-liner executed successfully ✓
- [ ] **STEP 6:** zz-security-headers.conf file created ✓
- [ ] **STEP 7:** No non-$host redirects found ✓
- [ ] **STEP 8:** No backticks found in any config ✓
- [ ] **STEP 9:** Duplicate configs removed ✓
- [ ] **STEP 10:** HTTPS headers verified (no backticks) ✓
- [ ] **STEP 11:** HTTP redirect verified (no backticks) ✓
- [ ] **STEP 12:** No nginx warnings ✓
- [ ] **STEP 13:** Nginx service running ✓
- [ ] **STEP 14:** Platform stack services verified ✓
- [ ] **STEP 15:** API endpoints responding ✓
- [ ] **STEP 16:** SSL/TLS certificate valid ✓
- [ ] **STEP 17:** Security headers visible externally ✓
- [ ] **STEP 18:** Deployment report generated ✓
- [ ] **STEP 19:** Artifacts saved ✓
- [ ] **STEP 20:** Global launch verified ✓

---

## ROLLBACK PROCEDURE (IF NEEDED)

**ONLY IF DEPLOYMENT FAILS:**

```bash
# Restore from backup
BACKUP_DIR="/root/nginx-backup-YYYYMMDD-HHMMSS"  # Replace with actual backup dir
systemctl stop nginx
rm -rf /etc/nginx
cp -r "$BACKUP_DIR/nginx" /etc/nginx/
if [ -d "$BACKUP_DIR/vhosts" ]; then
    rm -rf /var/www/vhosts/system
    cp -r "$BACKUP_DIR/system" /var/www/vhosts/
fi
nginx -t
systemctl start nginx
```

---

## TRAE SUCCESS CRITERIA

**DEPLOYMENT IS 100% COMPLETE WHEN:**

1. ✅ All 20 checklist items verified
2. ✅ Zero backticks in any header or config
3. ✅ Zero nginx warnings
4. ✅ All redirects use `$host` variable
5. ✅ Security headers present on all domains
6. ✅ HTTP→HTTPS redirect working
7. ✅ Platform stack services running
8. ✅ Deployment report generated
9. ✅ No deviations from this protocol
10. ✅ Global launch verified

---

## SUPPORT CONTACT

If ANY step fails or produces unexpected output:
1. STOP immediately
2. Do NOT proceed to next step
3. Document the exact error
4. Provide the step number and error message
5. Wait for guidance before continuing

---

**TRAE: Execute this protocol line-by-line. Mark each checkbox as you complete it. 100% completion required. No deviations. No pauses. Full deployment only.**

---

## END OF TRAE DEPLOYMENT GUIDE
